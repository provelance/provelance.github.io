<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Provelance v5.1 | ç¨³å®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --red: #da3633; --gold: #d29922; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 1. é¡¶éƒ¨è¿æ¥åŒº (ä¿®å¤ç‰ˆ) */
        .conn-bar { background: #010409; border-bottom: 1px solid var(--border); padding: 12px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .logo { font-weight: bold; color: var(--gold); font-size: 14px; white-space: nowrap; margin-right: 10px; }
        .input-group { display: flex; flex: 1; gap: 8px; min-width: 250px; }
        input.conf { background: #0d1117; border: 1px solid var(--border); color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; flex: 1; transition: 0.3s; }
        input.conf:focus { border-color: var(--blue); }
        button.conn-btn { background: var(--border); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        button.conn-btn.active { background: var(--blue); }

        /* 2. ä¸»å¸ƒå±€ */
        .layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        @media (max-width: 800px) { .layout { flex-direction: column; } }

        /* å·¦ä¾§ï¼šæ³•åˆ™åº“ */
        .panel-reg { width: 180px; background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-head { padding: 10px; font-size: 11px; font-weight: bold; color: #8b949e; background: var(--card); border-bottom: 1px solid var(--border); }
        .reg-list { flex: 1; overflow-y: auto; }
        .reg-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; cursor: pointer; color: var(--blue); }
        .reg-item:hover { background: #1f2428; }
        @media (max-width: 800px) { .panel-reg { width: 100%; height: auto; max-height: 120px; display: none; } .panel-reg.show { display: flex; } }

        /* ä¸­é—´ï¼šç¼–è¾‘å™¨ */
        .panel-edit { flex: 1; display: flex; flex-direction: column; background: #0d1117; position: relative; min-width: 0; }
        .toolbar { padding: 8px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; background: var(--card); align-items: center; }
        select.type-sel { background: var(--bg); border: 1px solid var(--border); color: white; padding: 6px; border-radius: 4px; font-size: 13px; }
        
        .code-area { flex: 1; position: relative; display: flex; flex-direction: column; }
        textarea#editor { flex: 1; background: transparent; color: #e6edf3; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; line-height: 1.5; }
        
        /* æ™ºèƒ½è¡¨æ ¼ */
        .smart-form { display: none; padding: 15px; flex: 1; overflow-y: auto; background: #0d1117; }
        .form-row { margin-bottom: 12px; }
        .form-label { display: block; font-size: 11px; color: var(--gold); margin-bottom: 4px; font-family: monospace; }
        .form-input { width: 100%; background: #161b22; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; }

        /* åº•éƒ¨æ“ä½œæ  (Sticky) */
        .action-bar { padding: 10px 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .status-light { font-size: 11px; color: #666; display: flex; align-items: center; gap: 5px; }
        .btn-commit { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-commit:disabled { opacity: 0.5; cursor: not-allowed; background: var(--border); }

        /* å³ä¾§ï¼šæ—¶é—´çº¿ */
        .panel-view { width: 320px; border-left: 1px solid var(--border); display: flex; flex-direction: column; background: #010409; }
        .timeline { flex: 1; overflow-y: auto; padding: 10px; }
        .t-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
        .t-head { padding: 8px; font-size: 11px; display: flex; justify-content: space-between; cursor: pointer; background: rgba(255,255,255,0.02); }
        .t-body { display: none; padding: 10px; font-size: 11px; border-top: 1px solid var(--border); font-family: monospace; white-space: pre-wrap; word-break: break-all; color: #8b949e; }
        .t-body.open { display: block; }
        
        .type-RULE { border-left: 3px solid var(--blue); }
        .type-ACTION { border-left: 3px solid var(--accent); }
        .type-ERROR { border-left: 3px solid var(--red); }
        
        .state-box { height: 140px; background: black; padding: 10px; border-top: 1px solid var(--border); overflow: auto; color: var(--blue); font-size: 11px; font-family: monospace; }

        @media (max-width: 800px) { .panel-view { height: 300px; width: 100%; border-left: none; border-top: 1px solid var(--border); } }
    </style>
</head>
<body onload="brython(); init();">

    <div class="conn-bar">
        <div class="logo">ğŸŒŒ PROVELANCE v5.1</div>
        <div class="input-group">
            <input type="text" id="repo" class="conf" placeholder="GitHub ç”¨æˆ·/ä»“åº“å (User/Repo)" onchange="saveConf()">
            <input type="password" id="token" class="conf" placeholder="GitHub Token (å¿…å¡«)" onchange="saveConf()">
            <button class="conn-btn" onclick="sync()" id="sync-btn">ğŸ”Œ åŒæ­¥å®‡å®™</button>
        </div>
        <button class="conn-btn" onclick="toggleRegPanel()" style="margin-left:auto; display:none;" id="mobile-menu">ğŸ“œ æ³•åˆ™è¡¨</button>
    </div>

    <div class="layout">
        <div class="panel-reg" id="reg-panel">
            <div class="panel-head">æ³•åˆ™ (REGISTRY)</div>
            <div class="reg-list" id="rule-list">
                <div style="padding:10px; color:#666; text-align:center;">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <div class="panel-edit">
            <div class="toolbar">
                <select id="mode-sel" class="type-sel" onchange="switchMode()">
                    <option value="ACTION">ğŸš€ è§¦å‘åŠ¨ä½œ (Trigger)</option>
                    <option value="RULE">âš–ï¸ å®šä¹‰æ³•åˆ™ (Define)</option>
                </select>
                
                <div style="flex:1; display:flex;">
                    <select id="rule-selector" class="type-sel" style="flex:1; display:none;" onchange="loadRuleForm()"></select>
                    <input type="text" id="rule-namer" class="conf" style="flex:1; display:none;" placeholder="è¾“å…¥æ–°æ³•åˆ™åç§° (å¦‚: trade)">
                </div>

                <button class="conn-btn" id="ui-toggle" onclick="toggleUI()">åˆ‡æ¢è¡¨å•</button>
            </div>

            <div class="code-area">
                <textarea id="editor" spellcheck="false" placeholder="åœ¨æ­¤è¾“å…¥ä»£ç ..." oninput="checkSyntax()"></textarea>
                <div id="smart-form" class="smart-form"></div>
            </div>

            <div class="action-bar">
                <div class="status-light">
                    <span id="syntax-dot">â—</span> 
                    <span id="status-text">å°±ç»ª</span>
                </div>
                <button class="btn-commit" id="commit-btn" onclick="commit()">âš¡ å†™å…¥å› æœ</button>
            </div>
        </div>

        <div class="panel-view">
            <div class="panel-head">å› æœæµ (TIMELINE)</div>
            <div class="timeline" id="timeline"></div>
            <div class="panel-head">å½“å‰çŠ¶æ€ (STATE)</div>
            <div class="state-box">
                <pre id="state-disp">{}</pre>
            </div>
        </div>
    </div>

    <script type="text/python">
    from browser import window
    import ast
    import traceback
    import sys

    # 1. é­”æ³•ä»£ç†ï¼šå…è®¸ s.balance è®¿é—®ï¼Œä¸”å®¹é”™
    class MagicProxy:
        def __init__(self, data):
            self.__dict__['_data'] = data
        def __getattr__(self, k):
            return self._data.get(k) # ä¸å­˜åœ¨è¿”å› Noneï¼Œä¸æŠ¥é”™
        def __setattr__(self, k, v):
            self._data[k] = v
        def __getitem__(self, k): return self._data.get(k)
        def __setitem__(self, k, v): self._data[k] = v

    # 2. å®‰å…¨è§£æå™¨ï¼šæ›¿ä»£ JS evalï¼Œæ”¯æŒ Python è¯­æ³•
    def py_parse(text):
        if not text or not text.strip(): return {}
        try:
            return ast.literal_eval(text)
        except Exception as e:
            return str(e) # è¿”å›é”™è¯¯å­—ç¬¦ä¸²

    # 3. æ‰§è¡Œå¼•æ“
    def py_run(code, state_dict, params_dict):
        # æ·±åº¦å¤åˆ¶é˜²æ­¢æ±¡æŸ“ï¼Ÿè¿™é‡Œç®€åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œå…è®¸ä¿®æ”¹
        s = MagicProxy(state_dict)
        p = MagicProxy(params_dict)
        
        # åŒ…è£…ä»£ç 
        indented = "\n".join(["    " + line for line in code.split("\n")])
        wrapper = f"def logic(s, p, state, params):\n{indented}\n"
        
        env = {'state': state_dict, 'params': params_dict, 's': s, 'p': p}
        
        try:
            exec(wrapper, env)
            # æ‰§è¡Œé€»è¾‘
            res = env['logic'](s, p, state_dict, params_dict)
            return res if res is not None else state_dict
        except Exception:
            etype, value, tb = sys.exc_info()
            return Exception("".join(traceback.format_exception(etype, value, tb)))

    def py_check(code):
        try:
            ast.parse(code)
            return True
        except:
            return False

    window.py_engine = {
        "parse": py_parse,
        "run": py_run,
        "check": py_check
    }
    </script>

    <script>
        let registry = {};
        let uiMode = 'CODE'; // CODE or FORM
        const LOG_FILE = "universe.log";

        function init() {
            // æ¢å¤é…ç½®
            const repo = localStorage.getItem('prov_repo');
            const token = localStorage.getItem('prov_token');
            if(repo) document.getElementById('repo').value = repo;
            if(token) document.getElementById('token').value = token;

            // ç§»åŠ¨ç«¯èœå•æ˜¾ç¤ºæ£€æµ‹
            if(window.innerWidth < 800) document.getElementById('mobile-menu').style.display = 'block';

            // åˆå§‹çŠ¶æ€
            switchMode();
            checkSyntax();
        }

        function saveConf() {
            localStorage.setItem('prov_repo', document.getElementById('repo').value);
            localStorage.setItem('prov_token', document.getElementById('token').value);
        }

        function toggleRegPanel() {
            document.getElementById('reg-panel').classList.toggle('show');
        }

        // --- æ ¸å¿ƒæ¨¡å¼åˆ‡æ¢ ---
        function switchMode() {
            const mode = document.getElementById('mode-sel').value;
            const rSel = document.getElementById('rule-selector');
            const rName = document.getElementById('rule-namer');
            const uiBtn = document.getElementById('ui-toggle');

            if (mode === 'ACTION') {
                rSel.style.display = 'block';
                rName.style.display = 'none';
                uiBtn.style.display = 'block';
                renderRuleSelect();
                loadRuleForm(); // åŠ è½½é€‰ä¸­è§„åˆ™çš„è¡¨å•
            } else {
                rSel.style.display = 'none';
                rName.style.display = 'block';
                uiBtn.style.display = 'none';
                setEditorView('CODE'); // å®šä¹‰è§„åˆ™å¼ºåˆ¶ä»£ç æ¨¡å¼
                document.getElementById('editor').value = "# s.balance += p.amount\nreturn s";
            }
        }

        function renderRuleSelect() {
            const sel = document.getElementById('rule-selector');
            sel.innerHTML = '';
            Object.keys(registry).forEach(k => {
                const opt = document.createElement('option');
                opt.value = opt.text = k;
                sel.appendChild(opt);
            });
        }

        // --- æ™ºèƒ½è¡¨å•é€»è¾‘ ---
        function loadRuleForm() {
            const ruleName = document.getElementById('rule-selector').value;
            if(!ruleName || !registry[ruleName]) return;
            
            // é»˜è®¤æ˜¾ç¤ºç©ºå‚æ•°
            document.getElementById('editor').value = "{}";
            
            // åˆ†æä»£ç æå–å‚æ•° p.xxx
            const code = registry[ruleName];
            const regex = /p\.([a-zA-Z0-9_]+)/g;
            const params = new Set();
            let m;
            while((m = regex.exec(code)) !== null) params.add(m[1]);

            // ç”Ÿæˆè¡¨å•
            const formDiv = document.getElementById('smart-form');
            formDiv.innerHTML = '';
            
            if(params.size === 0) {
                formDiv.innerHTML = '<div style="color:#666; font-size:12px;">æ­¤æ³•åˆ™æ— éœ€å‚æ•°</div>';
            } else {
                params.forEach(key => {
                    const row = document.createElement('div');
                    row.className = 'form-row';
                    row.innerHTML = `
                        <label class="form-label">${key.toUpperCase()}</label>
                        <input type="text" class="form-input" data-key="${key}" oninput="syncFormToCode()">
                    `;
                    formDiv.appendChild(row);
                });
            }
            
            // åˆ‡æ¢è§†å›¾
            if(uiMode === 'FORM') setEditorView('FORM');
            syncFormToCode(); // åˆå§‹åŒ–
        }

        function syncFormToCode() {
            const inputs = document.querySelectorAll('#smart-form input');
            let data = {};
            inputs.forEach(inp => {
                let v = inp.value;
                if(!isNaN(v) && v !== '') v = Number(v); // è‡ªåŠ¨è½¬æ•°å­—
                data[inp.dataset.key] = v;
            });
            // ä½¿ç”¨ Python é£æ ¼çš„å•å¼•å·
            document.getElementById('editor').value = JSON.stringify(data, null, 2).replace(/"/g, "'");
        }

        function toggleUI() {
            setEditorView(uiMode === 'CODE' ? 'FORM' : 'CODE');
        }

        function setEditorView(m) {
            uiMode = m;
            document.getElementById('editor').style.display = m === 'CODE' ? 'block' : 'none';
            document.getElementById('smart-form').style.display = m === 'FORM' ? 'block' : 'none';
            document.getElementById('ui-toggle').innerText = m === 'CODE' ? 'åˆ‡æ¢è¡¨å•' : 'åˆ‡æ¢ä»£ç ';
        }

        function checkSyntax() {
            const code = document.getElementById('editor').value;
            const dot = document.getElementById('syntax-dot');
            // ç®€å•æ£€æŸ¥
            const ok = window.py_engine.check(code); 
            dot.style.color = ok ? 'var(--accent)' : 'var(--red)';
        }

        // --- æ ¸å¿ƒåŒæ­¥ ---
        async function sync() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const btn = document.getElementById('sync-btn');
            
            if(!repo || !token) return alert("è¯·å…ˆå¡«å†™ Github ä»“åº“å’Œ Token");

            btn.innerText = "â³...";
            document.getElementById('status-text').innerText = "æ­£åœ¨æ‹‰å–å†å²...";

            try {
                let commits = [];
                let page = 1;
                const headers = {'Authorization': `token ${token}`};
                
                // æ‹‰å–
                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, {headers});
                    if(!res.ok) throw new Error("è¿æ¥å¤±è´¥: " + res.status);
                    const data = await res.json();
                    if(!data.length) break;
                    commits = commits.concat(data);
                    if(data.length < 100) break;
                    page++;
                }
                commits.reverse();

                // é‡æ”¾
                let state = {};
                registry = {};
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';
                const ruleList = document.getElementById('rule-list');
                ruleList.innerHTML = '';

                for(const c of commits) {
                    const msg = c.commit.message;
                    if(!msg.includes('|')) continue;
                    
                    const [head, ...bodyParts] = msg.split('\n');
                    const body = bodyParts.join('\n').trim();
                    const [type, name] = head.split('|').map(s => s.trim());
                    const time = new Date(c.commit.author.date).toLocaleTimeString();

                    const card = document.createElement('div');
                    card.className = `t-card type-${type}`;
                    
                    let content = '';
                    if(type === 'RULE') {
                        registry[name] = body;
                        content = `<span style="color:var(--blue)">å®šä¹‰æ³•åˆ™:</span>\n${body}`;
                    } else {
                        // ä½¿ç”¨ Python è§£æå‚æ•°ï¼Œè€Œä¸æ˜¯ JS eval
                        const params = window.py_engine.parse(body);
                        
                        if(typeof params === 'string') {
                            // è§£æå¤±è´¥
                            card.className += ' type-ERROR';
                            content = `å‚æ•°æ ¼å¼é”™è¯¯: ${params}\n${body}`;
                        } else {
                            // æ‰§è¡Œ
                            const ruleCode = registry[name] || "";
                            const res = window.py_engine.run(ruleCode, state, params);
                            
                            if(res instanceof Error) {
                                card.className += ' type-ERROR';
                                content = `âŒ å¡Œç¼© (${res.message})\nå‚æ•°: ${body}`;
                            } else {
                                state = res;
                                content = `âœ… æ‰§è¡ŒæˆåŠŸ\nå‚æ•°: ${body}`;
                            }
                        }
                    }

                    card.innerHTML = `
                        <div class="t-head" onclick="this.nextElementSibling.classList.toggle('open')">
                            <span>${type==='RULE'?'âš–ï¸':'ğŸš€'} ${name}</span>
                            <span style="opacity:0.6">${time}</span>
                        </div>
                        <div class="t-body">${content}</div>
                    `;
                    timeline.insertBefore(card, timeline.firstChild);
                }

                // æ›´æ–°UI
                document.getElementById('state-disp').innerText = JSON.stringify(state, null, 2);
                document.getElementById('status-text').innerText = "åŒæ­¥å®Œæˆ";
                
                Object.keys(registry).forEach(k => {
                    const d = document.createElement('div');
                    d.className = 'reg-item';
                    d.innerText = k;
                    d.onclick = () => {
                        document.getElementById('mode-sel').value = 'RULE';
                        document.getElementById('rule-namer').value = k;
                        document.getElementById('editor').value = registry[k];
                        switchMode();
                    };
                    ruleList.appendChild(d);
                });

                // å¦‚æœå½“å‰æ˜¯ ACTION æ¨¡å¼ï¼Œåˆ·æ–°ä¸€ä¸‹ä¸‹æ‹‰åˆ—è¡¨
                if(document.getElementById('mode-sel').value === 'ACTION') {
                    renderRuleSelect();
                }

                btn.innerText = "ğŸ”Œ åŒæ­¥å®‡å®™";

            } catch(e) {
                alert(e.message);
                btn.innerText = "é‡è¯•";
            }
        }

        async function commit() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const mode = document.getElementById('mode-sel').value;
            const name = mode === 'ACTION' ? document.getElementById('rule-selector').value : document.getElementById('rule-namer').value;
            const body = document.getElementById('editor').value;
            const btn = document.getElementById('commit-btn');

            if(!name) return alert("è¯·æŒ‡å®šåç§°");
            
            // æäº¤å‰æœ€åä¸€æ¬¡ Python è¯­æ³•æ£€æŸ¥
            if(mode === 'ACTION') {
                const check = window.py_engine.parse(body);
                if(typeof check === 'string') return alert("å‚æ•°æ ¼å¼é”™è¯¯ (è¯·ç¬¦åˆPythonå­—å…¸è¯­æ³•):\n" + check);
            } else {
                if(!window.py_engine.check(body)) return alert("Python ä»£ç è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç¼©è¿›æˆ–ç¬¦å·");
            }

            btn.disabled = true;
            btn.innerText = "å†™å…¥ä¸­...";

            try {
                // 1. Get SHA
                let sha = null;
                try {
                    const r = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {headers: {'Authorization': `token ${token}`}});
                    if(r.ok) sha = (await r.json()).sha;
                } catch(e) {}

                // 2. PUT
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT',
                    headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: `${mode} | ${name}\n\n${body}`,
                        content: btoa(`T:${Date.now()}`),
                        sha: sha
                    })
                });

                if(!res.ok) throw new Error("å†™å…¥è¢«æ‹’ç» (403/404/409)");
                
                btn.innerText = "âœ… å·²å†™å…¥";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "âš¡ å†™å…¥å› æœ";
                    sync();
                }, 1000);

            } catch(e) {
                alert("é”™è¯¯: " + e.message);
                btn.disabled = false;
                btn.innerText = "âš¡ å†™å…¥å› æœ";
            }
        }
    </script>
</body>
</html>
