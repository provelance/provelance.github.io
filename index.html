<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Provelance v5.0 | æ™ºèƒ½å› æœç»ˆç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --red: #da3633; --gold: #d29922; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, "Segoe UI", "Consolas", monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* å¯¼èˆª */
        .nav { background: #010409; border-bottom: 1px solid var(--border); padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .u-name { font-weight: bold; color: var(--gold); font-size: 14px; }
        .config-trigger { cursor: pointer; font-size: 18px; }

        /* ä¸»å¸ƒå±€ */
        .container { display: flex; flex: 1; overflow: hidden; position: relative; }
        @media (max-width: 900px) { .container { flex-direction: column; overflow-y: auto; } }

        /* é€šç”¨é¢æ¿ */
        .panel { display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid var(--border); }
        .p-header { padding: 10px; font-size: 11px; font-weight: bold; color: #8b949e; background: #161b22; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        
        /* 1. æ³•åˆ™åˆ—è¡¨ */
        .reg-panel { width: 180px; }
        .rule-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; transition: 0.2s; }
        .rule-item:hover { background: var(--card); border-left: 3px solid var(--gold); }

        /* 2. ç¼–è¾‘å™¨/è¡¨å• */
        .edit-panel { flex: 2; min-width: 350px; background: #0d1117; }
        .mode-bar { padding: 10px; display: flex; gap: 8px; background: var(--card); border-bottom: 1px solid var(--border); }
        select, input { background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-size: 14px; }
        
        .editor-box { flex: 1; position: relative; display: flex; flex-direction: column; }
        #code-editor { flex: 1; width: 100%; background: transparent; color: #e6edf3; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 15px; resize: none; outline: none; }
        
        /* æ™ºèƒ½è¡¨å• */
        .smart-form { display: none; padding: 20px; flex: 1; overflow-y: auto; background: #0d1117; }
        .form-row { margin-bottom: 15px; display: flex; flex-direction: column; gap: 5px; }
        .form-row label { font-size: 12px; color: var(--blue); font-weight: bold; }
        .form-row input { width: 100%; border-color: #444; }

        /* 3. æ—¶é—´çº¿/çŠ¶æ€ */
        .view-panel { width: 350px; border-left: 1px solid var(--border); }
        @media (max-width: 900px) { .reg-panel, .edit-panel, .view-panel { width: 100%; border: none; flex: none; } }

        /* åº•éƒ¨åŠ¨ä½œ */
        .action-bar { padding: 12px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; bottom: 0; }
        .btn { border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-sync { background: var(--border); color: var(--text); }
        .btn-commit { background: var(--accent); color: white; box-shadow: 0 4px 14px rgba(35,134,54,0.4); }

        /* æ—¶é—´çº¿é¡¹ */
        .timeline { flex: 1; overflow-y: auto; padding: 10px; background: #010409; }
        .t-item { border-radius: 6px; border: 1px solid var(--border); margin-bottom: 8px; background: var(--card); overflow: hidden; }
        .t-head { padding: 8px 12px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; }
        .t-body { display: none; padding: 10px; border-top: 1px solid var(--border); font-size: 12px; background: #000; }
        .active { display: block; }
        .err-tip { color: var(--red); font-family: monospace; font-size: 11px; margin-top: 5px; }

        /* è¯­æ³•é«˜äº®æ¨¡æ‹Ÿ */
        .syntax-hint { position: absolute; right: 10px; top: 10px; font-size: 10px; color: #666; pointer-events: none; }
    </style>
</head>
<body onload="brython(); init();">

    <div class="nav">
        <div class="u-name">ğŸŒŒ <span id="cur-universe">Loading...</span></div>
        <div style="display:flex; gap:10px;">
            <div id="lint-status" style="font-size:11px; color:var(--accent)">â— è¯­æ³•æ­£å¸¸</div>
            <div class="config-trigger" onclick="toggleConfig()">âš™ï¸</div>
        </div>
    </div>

    <div id="config-panel" style="display:none; padding:15px; background:var(--card); border-bottom:1px solid var(--border);">
        <input type="text" id="repo" placeholder="User/Repo" oninput="saveConfig()" style="width:45%">
        <input type="password" id="token" placeholder="GitHub Token" oninput="saveConfig()" style="width:45%">
    </div>

    <div class="container">
        <div class="panel reg-panel">
            <div class="p-header">æ³•åˆ™åˆ—è¡¨ (REGISTRY)</div>
            <div id="rule-list" style="overflow-y:auto"></div>
        </div>

        <div class="panel edit-panel">
            <div class="mode-bar">
                <select id="type-sel" onchange="switchMode()">
                    <option value="ACTION">ğŸš€ è§¦å‘åŠ¨ä½œ (ACTION)</option>
                    <option value="RULE">âš–ï¸ å®šä¹‰æ³•åˆ™ (RULE)</option>
                </select>
                <div id="func-input-wrap" style="flex:1; display:flex;">
                    <input type="text" id="rule-name" placeholder="æ–°æ³•åˆ™åç§°..." style="flex:1; display:none;">
                    <select id="action-target" onchange="handleTargetChange()" style="flex:1;"></select>
                </div>
                <button id="toggle-ui" class="btn btn-sync" onclick="toggleEditorMode()" style="padding:4px 10px; font-size:11px;">åˆ‡æ¢ UI</button>
            </div>

            <div class="editor-box">
                <div class="syntax-hint">PROVELANCE v5.0 | Python 3.x</div>
                <textarea id="code-editor" spellcheck="false" oninput="onCodeChange()" placeholder="è½½å…¥ä»£ç ..."></textarea>
                
                <div id="smart-form" class="smart-form"></div>
            </div>

            <div class="action-bar">
                <button class="btn btn-sync" onclick="sync()">ğŸ”Œ åŒæ­¥å…¨å¢ƒ</button>
                <button id="commit-btn" class="btn btn-commit" onclick="commit()">âš¡ å†™å…¥å› æœ</button>
            </div>
        </div>

        <div class="panel view-panel">
            <div class="p-header">å› æœæµ (TIMELINE)</div>
            <div id="timeline" class="timeline"></div>
            <div class="p-header">çŠ¶æ€ç†µ (STATE)</div>
            <div style="height:150px; background:#000; padding:10px; overflow:auto;">
                <pre id="state-json" style="margin:0; font-size:12px; color:var(--blue)"></pre>
            </div>
        </div>
    </div>

    <script type="text/python">
    from browser import window, console
    import ast, traceback, sys

    # æ ¸å¿ƒï¼šç‚¹å·è®¿é—®ä»£ç†
    class MagicProxy:
        def __init__(self, data):
            self.__dict__['_data'] = data
        def __getattr__(self, k):
            return self._data.get(k)
        def __setattr__(self, k, v):
            self._data[k] = v
        def __getitem__(self, k): return self._data[k]
        def __setitem__(self, k, v): self._data[k] = v

    def run_engine(code, state_dict, params_dict):
        # å‡†å¤‡ç¯å¢ƒï¼šåŒæ—¶æä¾› s, p å’ŒåŸç”Ÿçš„ state, params
        s = MagicProxy(state_dict)
        p = MagicProxy(params_dict)
        
        globals_env = {
            'state': state_dict, 
            'params': params_dict,
            's': s,
            'p': p,
            'console': console
        }
        
        # ä¸ºäº†æ”¯æŒ returnï¼ŒåŒ…è£…è¿›å‡½æ•°
        indented = "\n".join(["    " + line for line in code.split("\n")])
        wrapper = f"def _logic(s, p, state, params):\n{indented}\n"
        
        try:
            # è¯­æ³•æ£€æŸ¥
            ast.parse(code)
            exec(wrapper, globals_env)
            result = globals_env['_logic'](s, p, state_dict, params_dict)
            return result if result is not None else state_dict
        except Exception as e:
            etype, value, tb = sys.exc_info()
            return Exception("".join(traceback.format_exception(etype, value, tb)))

    def lint_check(code):
        try:
            ast.parse(code)
            return True
        except Exception as e:
            return str(e)

    window.causal_engine = {
        "run": run_engine,
        "lint": lint_check
    }
    </script>

    <script>
        let universeRegistry = {};
        let editorMode = 'CODE'; // CODE or FORM
        const LOG_FILE = "universe.log";

        function init() {
            document.getElementById('repo').value = localStorage.getItem('prov_repo') || '';
            document.getElementById('token').value = localStorage.getItem('prov_token') || '';
            updateUniverseUI();
            switchMode();
        }

        function saveConfig() {
            localStorage.setItem('prov_repo', document.getElementById('repo').value);
            localStorage.setItem('prov_token', document.getElementById('token').value);
            updateUniverseUI();
        }

        function updateUniverseUI() {
            const r = document.getElementById('repo').value;
            document.getElementById('cur-universe').innerText = r ? r.split('/').pop().toUpperCase() : 'PROVELANCE';
        }

        function toggleConfig() {
            const p = document.getElementById('config-panel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        }

        // --- æ ¸å¿ƒäº¤äº’é€»è¾‘ ---

        function switchMode() {
            const type = document.getElementById('type-sel').value;
            const rInp = document.getElementById('rule-name');
            const aSel = document.getElementById('action-target');
            const editor = document.getElementById('code-editor');

            if(type === 'RULE') {
                rInp.style.display = 'block';
                aSel.style.display = 'none';
                editor.value = "s.count = (s.count or 0) + p.step\nreturn s";
                setEditorDisplay('CODE');
            } else {
                rInp.style.display = 'none';
                aSel.style.display = 'block';
                updateActionTargets();
                handleTargetChange();
            }
        }

        function updateActionTargets() {
            const sel = document.getElementById('action-target');
            sel.innerHTML = '';
            Object.keys(universeRegistry).forEach(k => {
                const opt = document.createElement('option');
                opt.value = opt.text = k;
                sel.appendChild(opt);
            });
        }

        function handleTargetChange() {
            const target = document.getElementById('action-target').value;
            if(universeRegistry[target]) {
                document.getElementById('code-editor').value = "{\n  'step': 1\n}";
                autoGenerateForm(universeRegistry[target]);
            }
        }

        // --- æ™ºèƒ½è¯­æ³•ä¸è¡¨å• ---

        function onCodeChange() {
            const code = document.getElementById('code-editor').value;
            const status = window.causal_engine.lint(code);
            const el = document.getElementById('lint-status');
            if(status === true) {
                el.innerText = "â— è¯­æ³•æ­£å¸¸";
                el.style.color = "var(--accent)";
            } else {
                el.innerText = "â— è¯­æ³•é”™è¯¯";
                el.style.color = "var(--red)";
            }
        }

        function autoGenerateForm(ruleCode) {
            const form = document.getElementById('smart-form');
            form.innerHTML = '';
            // æ­£åˆ™æå– p.xxx æˆ– params['xxx']
            const pDotRegex = /p\.([a-zA-Z_]\w*)/g;
            const pKeyRegex = /params\[['"](\w+)['"]\]/g;
            let params = new Set();
            let match;
            while ((match = pDotRegex.exec(ruleCode)) !== null) params.add(match[1]);
            while ((match = pKeyRegex.exec(ruleCode)) !== null) params.add(match[1]);

            if(params.size === 0) {
                form.innerHTML = '<div style="color:#666; text-align:center">è¯¥æ³•åˆ™ä¸éœ€è¦å¤–éƒ¨å‚æ•°</div>';
                return;
            }

            params.forEach(p => {
                const row = document.createElement('div');
                row.className = 'form-row';
                row.innerHTML = `<label>${p.toUpperCase()}</label><input type="text" data-key="${p}" placeholder="è¾“å…¥å€¼..." oninput="syncFormToJson()">`;
                form.appendChild(row);
            });
        }

        function syncFormToJson() {
            const inputs = document.querySelectorAll('#smart-form input');
            let data = {};
            inputs.forEach(i => {
                let val = i.value;
                // è‡ªåŠ¨å°è¯•è½¬æ¢æ•°å­—
                if(!isNaN(val) && val !== '') val = Number(val);
                data[i.dataset.key] = val;
            });
            document.getElementById('code-editor').value = JSON.stringify(data, null, 2).replace(/"/g, "'");
        }

        function toggleEditorMode() {
            setEditorDisplay(editorMode === 'CODE' ? 'FORM' : 'CODE');
        }

        function setEditorDisplay(m) {
            editorMode = m;
            document.getElementById('code-editor').style.display = m === 'CODE' ? 'block' : 'none';
            document.getElementById('smart-form').style.display = m === 'FORM' ? 'block' : 'none';
            document.getElementById('toggle-ui').innerText = m === 'CODE' ? 'æ™ºèƒ½è¡¨å•' : 'åŸå§‹ä»£ç ';
        }

        // --- åŒæ­¥ä¸æäº¤ ---

        async function sync() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            if(!repo) return alert("è¯·é…ç½®ä»“åº“");

            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '<div style="padding:20px; text-align:center">ğŸŒªï¸ æ­£åœ¨æŠ˜å æ—¶é—´è½´...</div>';

            try {
                let commits = [];
                let page = 1;
                const headers = token ? {'Authorization': `token ${token}`} : {};
                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, {headers});
                    const data = await res.json();
                    if(!data.length || page > 5) break;
                    commits = commits.concat(data);
                    page++;
                }
                commits.reverse();

                let state = {};
                universeRegistry = {};
                timeline.innerHTML = '';

                for(const item of commits) {
                    const msg = item.commit.message;
                    if(!msg.includes('|')) continue;
                    
                    const [head, ...bodyArr] = msg.split('\n');
                    const body = bodyArr.join('\n').trim();
                    const [type, fName] = head.split('|').map(s => s.trim());
                    
                    const card = document.createElement('div');
                    card.className = `t-item type-${type}`;
                    let html = `<div class="t-head" onclick="this.nextElementSibling.classList.toggle('active')">
                                    <span>${type === 'RULE' ? 'âš–ï¸' : 'ğŸš€'} ${fName}</span>
                                    <small>${new Date(item.commit.author.date).toLocaleTimeString()}</small>
                                </div><div class="t-body">`;

                    if(type === 'RULE') {
                        universeRegistry[fName] = body;
                        html += `<pre style="color:var(--gold)">${body}</pre>`;
                    } else {
                        // æ‰§è¡Œ
                        const params = eval(`(${body})`); // ç®€å•è§£æ
                        const result = window.causal_engine.run(universeRegistry[fName] || "", state, params);
                        
                        if(result instanceof Error) {
                            card.style.borderColor = 'var(--red)';
                            html += `<div class="err-tip">åç¼©æŠ¥å‘Š:</div><pre class="err-tip">${result.message}</pre>`;
                        } else {
                            state = result;
                            html += `<pre style="color:var(--accent)">å‚æ•°: ${body}</pre>`;
                        }
                    }
                    card.innerHTML = html + `</div>`;
                    timeline.insertBefore(card, timeline.firstChild);
                }

                document.getElementById('state-json').innerText = JSON.stringify(state, null, 2);
                renderRuleList();
                updateActionTargets();
                document.getElementById('status-text').innerText = "å®‡å®™å·²è¾¾ç¨³æ€";
            } catch(e) {
                alert("åŒæ­¥å¤±è´¥: " + e.message);
            }
        }

        function renderRuleList() {
            const list = document.getElementById('rule-list');
            list.innerHTML = '';
            Object.keys(universeRegistry).forEach(k => {
                const div = document.createElement('div');
                div.className = 'rule-item';
                div.innerText = k;
                div.onclick = () => {
                    document.getElementById('type-sel').value = 'RULE';
                    document.getElementById('rule-name').value = k;
                    document.getElementById('code-editor').value = universeRegistry[k];
                    switchMode();
                };
                list.appendChild(div);
            });
        }

        async function commit() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const type = document.getElementById('type-sel').value;
            const name = type === 'ACTION' ? document.getElementById('action-target').value : document.getElementById('rule-name').value;
            const body = document.getElementById('code-editor').value;
            const btn = document.getElementById('commit-btn');

            if(!name || !token) return alert("è¯·ç¡®ä¿å¡«å†™äº†åç§°å’Œ Token");

            btn.disabled = true;
            btn.innerText = "å†™å…¥ä¸­...";

            try {
                let sha = null;
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, { headers: {'Authorization': `token ${token}`} });
                if(getRes.ok) sha = (await getRes.json()).sha;

                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT',
                    headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: `${type} | ${name}\n\n${body}`, 
                        content: btoa(`Timestamp: ${Date.now()}`), 
                        sha: sha 
                    })
                });

                if(!res.ok) throw new Error("GitHub API æ‹’ç»äº†å†™å…¥");
                btn.innerText = "âœ… æˆåŠŸ";
                setTimeout(() => { btn.disabled = false; btn.innerText = "âš¡ å†™å…¥å› æœ"; sync(); }, 1000);
            } catch(e) {
                alert(e.message);
                btn.disabled = false;
                btn.innerText = "âš¡ å†™å…¥å› æœ";
            }
        }
    </script>
</body>
</html>
