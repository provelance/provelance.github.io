<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Provelance v5.2 | ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --red: #da3633; --gold: #d29922; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* å¯¼èˆªä¸é…ç½® */
        .conn-bar { background: #010409; border-bottom: 1px solid var(--border); padding: 12px; display: flex; gap: 10px; align-items: center; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .logo { font-weight: bold; color: var(--gold); font-size: 14px; white-space: nowrap; margin-right: 5px; }
        .input-group { display: flex; flex: 1; gap: 8px; min-width: 0; }
        input.conf { background: #0d1117; border: 1px solid var(--border); color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; flex: 1; transition: 0.3s; min-width: 0; }
        input.conf:focus { border-color: var(--blue); }
        button.conn-btn { background: var(--border); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        
        /* å¸ƒå±€ */
        .layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        @media (max-width: 800px) { .layout { flex-direction: column; } }

        /* å·¦ä¾§åˆ—è¡¨ */
        .panel-reg { width: 180px; background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-head { padding: 10px; font-size: 11px; font-weight: bold; color: #8b949e; background: var(--card); border-bottom: 1px solid var(--border); }
        .reg-list { flex: 1; overflow-y: auto; }
        .reg-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; cursor: pointer; color: var(--blue); }
        .reg-item:hover { background: #1f2428; }
        @media (max-width: 800px) { .panel-reg { width: 100%; height: auto; max-height: 0; overflow: hidden; transition: max-height 0.3s; border-right: none; border-bottom: 1px solid var(--border); } .panel-reg.show { max-height: 200px; } }

        /* ä¸­é—´ç¼–è¾‘ */
        .panel-edit { flex: 1; display: flex; flex-direction: column; background: #0d1117; min-width: 0; }
        .toolbar { padding: 8px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; background: var(--card); align-items: center; }
        select.type-sel { background: var(--bg); border: 1px solid var(--border); color: white; padding: 6px; border-radius: 4px; font-size: 13px; max-width: 120px; }
        .code-area { flex: 1; position: relative; display: flex; flex-direction: column; }
        textarea#editor { flex: 1; background: transparent; color: #e6edf3; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; line-height: 1.5; }
        .smart-form { display: none; padding: 15px; flex: 1; overflow-y: auto; background: #0d1117; }
        .form-row { margin-bottom: 12px; }
        .form-label { display: block; font-size: 11px; color: var(--gold); margin-bottom: 4px; font-family: monospace; }
        .form-input { width: 100%; background: #161b22; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; }
        
        .action-bar { padding: 10px 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .status-light { font-size: 11px; color: #666; display: flex; align-items: center; gap: 5px; }
        .btn-commit { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-commit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å³ä¾§è§†å›¾ */
        .panel-view { width: 320px; border-left: 1px solid var(--border); display: flex; flex-direction: column; background: #010409; }
        .timeline { flex: 1; overflow-y: auto; padding: 10px; }
        .t-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
        .t-head { padding: 8px; font-size: 11px; display: flex; justify-content: space-between; cursor: pointer; background: rgba(255,255,255,0.02); }
        .t-body { display: none; padding: 10px; font-size: 11px; border-top: 1px solid var(--border); font-family: monospace; white-space: pre-wrap; word-break: break-all; color: #8b949e; }
        .t-body.open { display: block; }
        .type-RULE { border-left: 3px solid var(--blue); }
        .type-ACTION { border-left: 3px solid var(--accent); }
        .type-ERROR { border-left: 3px solid var(--red); }
        
        .state-box { height: 140px; background: black; padding: 10px; border-top: 1px solid var(--border); overflow: auto; color: var(--blue); font-size: 11px; font-family: monospace; }
        @media (max-width: 800px) { .panel-view { height: 300px; width: 100%; border-left: none; border-top: 1px solid var(--border); } }
    </style>
</head>
<body onload="brython(); init();">

    <div class="conn-bar">
        <div class="logo">ğŸŒŒ V5.2</div>
        <div class="input-group">
            <input type="text" id="repo" class="conf" placeholder="User/Repo" onchange="saveConf()">
            <input type="password" id="token" class="conf" placeholder="GitHub Token" onchange="saveConf()">
            <button class="conn-btn" onclick="sync()" id="sync-btn">ğŸ”Œ åŒæ­¥</button>
        </div>
        <button class="conn-btn" onclick="toggleRegPanel()" style="margin-left:auto; display:none;" id="mobile-menu">ğŸ“œ</button>
    </div>

    <div class="layout">
        <div class="panel-reg" id="reg-panel">
            <div class="panel-head">æ³•åˆ™ (REGISTRY)</div>
            <div class="reg-list" id="rule-list"></div>
        </div>

        <div class="panel-edit">
            <div class="toolbar">
                <select id="mode-sel" class="type-sel" onchange="switchMode()">
                    <option value="ACTION">ğŸš€ è§¦å‘</option>
                    <option value="RULE">âš–ï¸ å®šä¹‰</option>
                </select>
                <div style="flex:1; display:flex; min-width: 0;">
                    <select id="rule-selector" class="type-sel" style="flex:1; display:none;" onchange="loadRuleForm()"></select>
                    <input type="text" id="rule-namer" class="conf" style="flex:1; display:none;" placeholder="æ³•åˆ™åç§°">
                </div>
                <button class="conn-btn" id="ui-toggle" onclick="toggleUI()">è¡¨å•</button>
            </div>

            <div class="code-area">
                <textarea id="editor" spellcheck="false" placeholder="ç­‰å¾…è¿æ¥..." oninput="checkSyntax()"></textarea>
                <div id="smart-form" class="smart-form"></div>
            </div>

            <div class="action-bar">
                <div class="status-light"><span id="syntax-dot">â—</span><span id="status-text">å°±ç»ª</span></div>
                <button class="btn-commit" id="commit-btn" onclick="commit()">âš¡ å†™å…¥å› æœ</button>
            </div>
        </div>

        <div class="panel-view">
            <div class="panel-head">å› æœæµ (TIMELINE)</div>
            <div class="timeline" id="timeline"></div>
            <div class="panel-head">çŠ¶æ€ (STATE)</div>
            <div class="state-box"><pre id="state-disp">{}</pre></div>
        </div>
    </div>

    <script type="text/python">
    from browser import window
    import ast
    import traceback
    import sys

    # 1. ä»£ç†å¯¹è±¡
    class MagicProxy:
        def __init__(self, data): self.__dict__['_data'] = data
        def __getattr__(self, k): return self._data.get(k)
        def __setattr__(self, k, v): self._data[k] = v
        def __getitem__(self, k): return self._data.get(k)
        def __setitem__(self, k, v): self._data[k] = v

    # 2. å®‰å…¨è§£æ
    def py_parse(text):
        if not text or not text.strip(): return {}
        try: return ast.literal_eval(text)
        except Exception as e: return str(e)

    # 3. å¥å£®çš„æ‰§è¡Œå¼•æ“ (ä¿®å¤ traceback å´©æºƒ)
    def py_run(code, state_dict, params_dict):
        s = MagicProxy(state_dict)
        p = MagicProxy(params_dict)
        wrapper = f"def logic(s, p, state, params):\n" + "\n".join(["    " + l for l in code.split('\n')]) + "\n"
        env = {'state': state_dict, 'params': params_dict, 's': s, 'p': p}
        
        try:
            exec(wrapper, env)
            res = env['logic'](s, p, state_dict, params_dict)
            return res if res is not None else state_dict
        except Exception as e:
            # --- å…³é”®ä¿®å¤ ---
            try:
                # å°è¯•æ ‡å‡†å †æ ˆæ‰“å°
                etype, value, tb = sys.exc_info()
                return Exception("".join(traceback.format_exception(etype, value, tb)))
            except:
                # å¦‚æœ traceback æ¨¡å—æœ¬èº«å´©æºƒ (å¦‚ east_asian_width)ï¼Œé™çº§è¿”å›ç®€å•é”™è¯¯
                # è¿™æ ·å¯ä»¥é˜²æ­¢æ•´ä¸ªåŒæ­¥å¾ªç¯ä¸­æ–­
                return Exception(f"Runtime Error: {str(e)}\n(Detailed stack trace failed due to encoding)")

    def py_check(code):
        try: ast.parse(code); return True
        except: return False

    window.py_engine = {"parse": py_parse, "run": py_run, "check": py_check}
    </script>

    <script>
        let registry = {};
        let uiMode = 'CODE';
        const LOG_FILE = "universe.log";

        function init() {
            const r = localStorage.getItem('prov_repo');
            const t = localStorage.getItem('prov_token');
            if(r) document.getElementById('repo').value = r;
            if(t) document.getElementById('token').value = t;
            if(window.innerWidth < 800) document.getElementById('mobile-menu').style.display = 'block';
            switchMode();
        }

        function saveConf() {
            localStorage.setItem('prov_repo', document.getElementById('repo').value);
            localStorage.setItem('prov_token', document.getElementById('token').value);
        }

        function toggleRegPanel() {
            document.getElementById('reg-panel').classList.toggle('show');
        }

        function switchMode() {
            const mode = document.getElementById('mode-sel').value;
            const rSel = document.getElementById('rule-selector');
            const rName = document.getElementById('rule-namer');
            const uiBtn = document.getElementById('ui-toggle');

            if (mode === 'ACTION') {
                rSel.style.display = 'block';
                rName.style.display = 'none';
                uiBtn.style.display = 'block';
                renderRuleSelect();
                loadRuleForm();
            } else {
                rSel.style.display = 'none';
                rName.style.display = 'block';
                uiBtn.style.display = 'none';
                setEditorView('CODE');
                document.getElementById('editor').value = "# s.key = p.val\nreturn s";
            }
        }

        function renderRuleSelect() {
            const sel = document.getElementById('rule-selector');
            sel.innerHTML = '';
            Object.keys(registry).forEach(k => {
                const opt = document.createElement('option');
                opt.value = opt.text = k;
                sel.appendChild(opt);
            });
        }

        function loadRuleForm() {
            const ruleName = document.getElementById('rule-selector').value;
            if(!ruleName || !registry[ruleName]) return;
            document.getElementById('editor').value = "{}";
            const code = registry[ruleName];
            const regex = /p\.([a-zA-Z0-9_]+)/g;
            const params = new Set();
            let m;
            while((m = regex.exec(code)) !== null) params.add(m[1]);

            const formDiv = document.getElementById('smart-form');
            formDiv.innerHTML = '';
            if(params.size === 0) {
                formDiv.innerHTML = '<div style="color:#666; font-size:12px; text-align:center;">æ— æ³•åˆ™å‚æ•°</div>';
            } else {
                params.forEach(key => {
                    const row = document.createElement('div');
                    row.className = 'form-row';
                    row.innerHTML = `<label class="form-label">${key.toUpperCase()}</label><input type="text" class="form-input" data-key="${key}" oninput="syncFormToCode()">`;
                    formDiv.appendChild(row);
                });
            }
            if(uiMode === 'FORM') setEditorView('FORM');
            syncFormToCode();
        }

        function syncFormToCode() {
            const inputs = document.querySelectorAll('#smart-form input');
            let data = {};
            inputs.forEach(inp => {
                let v = inp.value;
                if(!isNaN(v) && v !== '') v = Number(v);
                data[inp.dataset.key] = v;
            });
            document.getElementById('editor').value = JSON.stringify(data, null, 2).replace(/"/g, "'");
        }

        function toggleUI() { setEditorView(uiMode === 'CODE' ? 'FORM' : 'CODE'); }
        
        function setEditorView(m) {
            uiMode = m;
            document.getElementById('editor').style.display = m === 'CODE' ? 'block' : 'none';
            document.getElementById('smart-form').style.display = m === 'FORM' ? 'block' : 'none';
            document.getElementById('ui-toggle').innerText = m === 'CODE' ? 'è¡¨å•' : 'ä»£ç ';
        }

        function checkSyntax() {
            const code = document.getElementById('editor').value;
            const ok = window.py_engine.check(code); 
            document.getElementById('syntax-dot').style.color = ok ? 'var(--accent)' : 'var(--red)';
        }

        async function sync() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const btn = document.getElementById('sync-btn');
            if(!repo || !token) return alert("è¯·é…ç½®ä»“åº“ä¿¡æ¯");

            btn.innerText = "â³";
            
            try {
                let commits = [];
                let page = 1;
                const headers = {'Authorization': `token ${token}`};
                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, {headers});
                    if(!res.ok) throw new Error("APIè¿æ¥å¤±è´¥");
                    const data = await res.json();
                    if(!data.length) break;
                    commits = commits.concat(data);
                    if(data.length < 100) break;
                    page++;
                }
                commits.reverse();

                let state = {};
                registry = {};
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';
                const ruleList = document.getElementById('rule-list');
                ruleList.innerHTML = '';

                for(const c of commits) {
                    const msg = c.commit.message;
                    if(!msg.includes('|')) continue;
                    const [head, ...bodyParts] = msg.split('\n');
                    const body = bodyParts.join('\n').trim();
                    const [type, name] = head.split('|').map(s => s.trim());
                    const time = new Date(c.commit.author.date).toLocaleTimeString();

                    const card = document.createElement('div');
                    card.className = `t-card type-${type}`;
                    let content = '';

                    if(type === 'RULE') {
                        registry[name] = body;
                        content = `<span style="color:var(--blue)">å®šä¹‰:</span>\n${body}`;
                    } else {
                        const params = window.py_engine.parse(body);
                        if(typeof params === 'string') {
                            card.className += ' type-ERROR';
                            content = `å‚æ•°è§£æå¤±è´¥: ${params}\n${body}`;
                        } else {
                            const ruleCode = registry[name] || "";
                            // è¿™é‡Œæ˜¯å…³é”®ï¼šå³ä½¿ py_run å†…éƒ¨æŠ¥é”™ï¼Œç°åœ¨ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª Exception å¯¹è±¡
                            const res = window.py_engine.run(ruleCode, state, params);
                            if(res instanceof Error) {
                                card.className += ' type-ERROR';
                                content = `âŒ å¡Œç¼©: ${res.message}\nå‚æ•°: ${body}`;
                            } else {
                                state = res;
                                content = `âœ… æˆåŠŸ: ${body}`;
                            }
                        }
                    }
                    card.innerHTML = `<div class="t-head" onclick="this.nextElementSibling.classList.toggle('open')"><span>${type==='RULE'?'âš–ï¸':'ğŸš€'} ${name}</span><span style="opacity:0.6">${time}</span></div><div class="t-body">${content}</div>`;
                    timeline.insertBefore(card, timeline.firstChild);
                }

                document.getElementById('state-disp').innerText = JSON.stringify(state, null, 2);
                
                // æ¸²æŸ“ Registry
                Object.keys(registry).forEach(k => {
                    const d = document.createElement('div');
                    d.className = 'reg-item';
                    d.innerText = k;
                    d.onclick = () => {
                        document.getElementById('mode-sel').value = 'RULE';
                        document.getElementById('rule-namer').value = k;
                        document.getElementById('editor').value = registry[k];
                        switchMode();
                    };
                    ruleList.appendChild(d);
                });
                
                if(document.getElementById('mode-sel').value === 'ACTION') renderRuleSelect();
                btn.innerText = "ğŸ”Œ åŒæ­¥";
                document.getElementById('status-text').innerText = "å·²åŒæ­¥";

            } catch(e) {
                alert("åŒæ­¥ä¸­æ–­: " + e.message);
                btn.innerText = "é‡è¯•";
            }
        }

        async function commit() {
            // Commit é€»è¾‘ä¿æŒä¸å˜ï¼Œä¾èµ– checkSyntax çš„ä¿æŠ¤
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const mode = document.getElementById('mode-sel').value;
            const name = mode === 'ACTION' ? document.getElementById('rule-selector').value : document.getElementById('rule-namer').value;
            const body = document.getElementById('editor').value;
            const btn = document.getElementById('commit-btn');

            if(!name) return alert("åç§°ç¼ºå¤±");
            if(mode === 'RULE' && !window.py_engine.check(body)) return alert("Python è¯­æ³•é”™è¯¯");
            if(mode === 'ACTION') {
                 const c = window.py_engine.parse(body);
                 if(typeof c === 'string') return alert("å‚æ•°å­—å…¸æ ¼å¼é”™è¯¯: " + c);
            }

            btn.disabled = true;
            btn.innerText = "...";

            try {
                let sha = null;
                try {
                    const r = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {headers: {'Authorization': `token ${token}`}});
                    if(r.ok) sha = (await r.json()).sha;
                } catch(e) {}

                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT'
