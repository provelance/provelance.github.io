<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‡å®™å› æœæ§åˆ¶ç»ˆç«¯ | Provelance Console</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --red: #da3633; }
        body { font-family: 'Segoe UI', 'Consolas', monospace; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar { background: #010409; border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; gap: 15px; height: 50px; }
        .logo { font-weight: bold; color: var(--text); letter-spacing: 1px; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--accent); }
        .config-area { margin-left: auto; display: flex; gap: 10px; }
        input.config { background: #0d1117; border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; width: 180px; font-size: 12px; }
        button.connect-btn { background: var(--border); color: var(--text); border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        button.connect-btn:hover { background: var(--blue); color: white; }

        /* ä¸»å¸ƒå±€ï¼šä¸‰æ è®¾è®¡ */
        .main-layout { display: grid; grid-template-columns: 260px 1fr 350px; flex: 1; min-height: 0; }
        
        /* é€šç”¨é¢æ¿æ ·å¼ */
        .panel { border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); }
        .panel:last-child { border-right: none; background: #010409; }
        .panel-header { padding: 10px 15px; font-size: 12px; font-weight: bold; color: #8b949e; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .panel-body { flex: 1; overflow-y: auto; padding: 0; position: relative; }

        /* å·¦æ ï¼šè§„åˆ™åº“ */
        .rule-item { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; font-size: 13px; }
        .rule-item:hover { background: var(--card); border-left: 3px solid var(--blue); }
        .rule-tag { display: inline-block; background: rgba(88, 166, 255, 0.1); color: var(--blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 8px; }

        /* ä¸­æ ï¼šç¼–è¾‘å™¨ */
        .editor-wrapper { display: flex; flex-direction: column; height: 100%; }
        .editor-toolbar { padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid var(--border); background: var(--card); }
        select, input.func-name { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; font-family: inherit; }
        input.func-name { flex: 1; font-weight: bold; }
        textarea#code-editor { flex: 1; background: #0d1117; color: #e6edf3; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; resize: none; outline: none; }
        .commit-bar { padding: 15px; border-top: 1px solid var(--border); background: var(--card); text-align: right; }
        button.commit-btn { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.commit-btn:hover { background: #2ea043; transform: scale(1.02); }
        button.commit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å³æ ï¼šæ—¶é—´çº¿ä¸çŠ¶æ€ */
        .timeline-container { flex: 1; overflow-y: auto; padding: 15px; border-bottom: 1px solid var(--border); }
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 15px; border-left: 2px solid var(--border); }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .timeline-item.type-RULE::before { background: var(--blue); }
        .timeline-item.type-ACTION::before { background: var(--accent); }
        .timeline-item.type-ERROR::before { background: var(--red); }
        
        .t-header { font-size: 12px; color: #8b949e; margin-bottom: 4px; }
        .t-title { font-size: 13px; font-weight: bold; margin-bottom: 4px; }
        .t-detail { font-size: 11px; color: #666; font-family: monospace; white-space: pre-wrap; max-height: 60px; overflow: hidden; opacity: 0.7; }

        .state-container { height: 300px; background: #000; display: flex; flex-direction: column; }
        pre#final-state { margin: 0; padding: 15px; color: #a5d6ff; font-size: 12px; flex: 1; overflow: auto; white-space: pre-wrap; }
    </style>
</head>
<body onload="brython(); init();">

    <div class="navbar">
        <div class="logo">ğŸŒŒ <span>Provelance</span> æ§åˆ¶ç»ˆç«¯</div>
        <div class="config-area">
            <input type="text" id="repo" class="config" placeholder="Githubç”¨æˆ·å/ä»“åº“å">
            <input type="password" id="token" class="config" placeholder="Github Token (å¿…å¡«)">
            <button class="connect-btn" onclick="syncUniverse()">ğŸ”Œ åŒæ­¥å®‡å®™</button>
        </div>
    </div>

    <div class="main-layout">
        
        <div class="panel">
            <div class="panel-header">ğŸ“š è§„åˆ™æ³•åˆ™ (Registry)</div>
            <div class="panel-body" id="rule-list">
                <div style="padding:20px; text-align:center; color:#666; font-size:12px;">ç­‰å¾…åŒæ­¥...</div>
            </div>
        </div>

        <div class="panel">
            <div class="editor-wrapper">
                <div class="editor-toolbar">
                    <select id="commit-type" onchange="loadTemplate()">
                        <option value="ACTION">ğŸš€ æ‰§è¡ŒåŠ¨ä½œ (Trigger Action)</option>
                        <option value="RULE">âš–ï¸ å®šä¹‰è§„åˆ™ (Define Rule)</option>
                    </select>
                    <input type="text" id="commit-name" class="func-name" placeholder="å‡½æ•°å (å¦‚: trade)">
                </div>
                <textarea id="code-editor" placeholder="åœ¨æ­¤è¾“å…¥ä»£ç ..."></textarea>
                <div class="commit-bar">
                    <button id="btn-submit" class="commit-btn" onclick="commit()">âš¡ å†™å…¥å› æœ (Commit)</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">â³ å®‡å®™æ¼”åŒ– (Timeline)</div>
            <div class="timeline-container" id="timeline">
                <div style="text-align:center; color:#666; font-size:12px; margin-top:20px;">ç©ºå¯‚æ— å£°ã€‚</div>
            </div>
            
            <div class="panel-header">ğŸ‘ï¸ æœ€æ–°çŠ¶æ€ (State)</div>
            <div class="state-container">
                <pre id="final-state">{}</pre>
            </div>
        </div>

    </div>

    <script type="text/python">
    from browser import window
    import ast

    def parse_params(data_str):
        if not data_str or not data_str.strip(): return {}
        try:
            return ast.literal_eval(data_str)
        except Exception as e:
            return None # æ ‡è®°è§£æå¤±è´¥

    def execute_python_rule(user_code_str, state, params):
        # 1. è‡ªåŠ¨ç¼©è¿›åŒ…è£…
        lines = user_code_str.split('\n')
        indented = '\n'.join(['    ' + l for l in lines])
        wrapped = f"def logic(state, params):\n{indented}\n    return state"
        loc = {}
        try:
            exec(wrapped, {}, loc)
            new_state = loc['logic'](state, params)
            return new_state if new_state is not None else state
        except Exception as e:
            raise e

    window.parse_params = parse_params
    window.execute_python_rule = execute_python_rule
    </script>

    <script>
        const LOG_FILE = "universe.log";
        let registry = {};
        
        function init() {
            document.getElementById('repo').value = localStorage.getItem('provelance_repo') || '';
            document.getElementById('token').value = localStorage.getItem('provelance_token') || '';
            loadTemplate();
        }

        function loadTemplate() {
            const type = document.getElementById('commit-type').value;
            const editor = document.getElementById('code-editor');
            if(type === 'RULE') {
                editor.value = `# å®šä¹‰é€»è¾‘\nstate['last_update'] = 'now'\nreturn state`;
            } else {
                editor.value = `{\n    'amount': 100,\n    'desc': 'test'\n}`;
            }
        }

        // --- æ ¸å¿ƒï¼šæ‹‰å–å¹¶æ¨æ¼” ---
        async function syncUniverse() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            if(!repo) return;
            localStorage.setItem('provelance_repo', repo);
            localStorage.setItem('provelance_token', token);

            const timelineDiv = document.getElementById('timeline');
            timelineDiv.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ“¡ æ­£åœ¨æ¥æ”¶æ¥è‡ª GitHub çš„å› æœæ³¢...</div>';

            try {
                // 1. æ‹‰å–æ‰€æœ‰ Commit
                let commits = [];
                let page = 1;
                const headers = token ? { 'Authorization': `token ${token}` } : {};

                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, { headers });
                    if (!res.ok) throw new Error("è¿æ¥æ–­å¼€ (404/403)");
                    const data = await res.json();
                    if (!data.length) break;
                    commits = commits.concat(data);
                    if (data.length < 100) break;
                    page++;
                }
                
                commits.reverse(); // æŒ‰æ—¶é—´æ­£åºæ’åˆ—

                // 2. æ¨æ¼”å¹¶æ¸²æŸ“æ—¶é—´çº¿
                timelineDiv.innerHTML = '';
                let state = {};
                registry = {};
                const ruleListDiv = document.getElementById('rule-list');
                ruleListDiv.innerHTML = '';

                for (const item of commits) {
                    const fullMsg = item.commit.message;
                    const splitIndex = fullMsg.indexOf('\n');
                    let title = (splitIndex === -1 ? fullMsg : fullMsg.substring(0, splitIndex)).trim();
                    let body = (splitIndex === -1 ? "" : fullMsg.substring(splitIndex)).trim();

                    if (!title.includes('|')) continue; // è·³è¿‡æ— å…³ Commit

                    const [type, funcName] = title.split('|').map(s => s.trim());
                    const time = new Date(item.commit.author.date).toLocaleTimeString();
                    const shortSha = item.sha.substring(0, 7);

                    // æ¸²æŸ“æ—¶é—´çº¿å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = `timeline-item type-${type}`; // type-RULE or type-ACTION
                    
                    if (type === 'RULE') {
                        registry[funcName] = body;
                        card.innerHTML = `
                            <div class="t-header">${time} â€¢ ${shortSha}</div>
                            <div class="t-title">ğŸ“œ å®šä¹‰æ³•åˆ™: ${funcName}</div>
                            <div class="t-detail">${body.substring(0, 100)}...</div>
                        `;
                        
                        // æ›´æ–°å·¦ä¾§è§„åˆ™åˆ—è¡¨ (æ€»æ˜¯æœ€æ–°çš„åœ¨æœ€å‰ï¼Œè™½ç„¶è¿™é‡Œæ˜¯æ­£åºéå†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨éå†ç»“æŸåç»Ÿä¸€åˆ·æ–°ï¼Œæˆ–è€…ç”¨ insertBefore)
                        // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼šæ¯æ¬¡é‡åˆ° RULE éƒ½æ›´æ–° registryï¼Œæœ€åæ¸²æŸ“åˆ—è¡¨
                    } 
                    else if (type === 'ACTION') {
                        try {
                            if (!registry[funcName]) throw new Error(`æ³•åˆ™ [${funcName}] æœªå®šä¹‰`);
                            
                            const params = window.parse_params(body);
                            if (params === null) throw new Error("å‚æ•°è§£æå¤±è´¥");

                            state = window.execute_python_rule(registry[funcName], state, params);
                            
                            card.innerHTML = `
                                <div class="t-header">${time} â€¢ ${shortSha}</div>
                                <div class="t-title" style="color:var(--accent)">ğŸš€ è§¦å‘äº‹ä»¶: ${funcName}</div>
                                <div class="t-detail">${JSON.stringify(params)}</div>
                            `;
                        } catch (e) {
                            card.className += ' type-ERROR';
                            card.innerHTML = `
                                <div class="t-header">${time} â€¢ ${shortSha}</div>
                                <div class="t-title" style="color:var(--red)">âŒ åç¼©: ${funcName}</div>
                                <div class="t-detail">${e.message}</div>
                            `;
                            state.errors = state.errors || [];
                            state.errors.push({sha: shortSha, error: e.message});
                        }
                    }
                    // å°†å¡ç‰‡æ’å…¥æ—¶é—´çº¿é¡¶éƒ¨ï¼ˆå€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
                    timelineDiv.insertBefore(card, timelineDiv.firstChild);
                }

                // 3. æ¸²æŸ“å·¦ä¾§è§„åˆ™åˆ—è¡¨ (å€’åº)
                Object.keys(registry).reverse().forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'rule-item';
                    div.innerHTML = `<span class="rule-tag">RULE</span>${key}`;
                    div.onclick = () => {
                        document.getElementById('commit-type').value = 'RULE';
                        document.getElementById('commit-name').value = key;
                        document.getElementById('code-editor').value = registry[key];
                    };
                    ruleListDiv.appendChild(div);
                });

                // 4. æ›´æ–°æœ€ç»ˆçŠ¶æ€
                document.getElementById('final-state').textContent = JSON.stringify(state, null, 2);

            } catch (e) {
                alert("åŒæ­¥å¤±è´¥: " + e.message);
            }
        }

        // --- æ ¸å¿ƒï¼šå†™å…¥ Commit ---
        async function commit() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const type = document.getElementById('commit-type').value;
            const name = document.getElementById('commit-name').value.trim();
            const body = document.getElementById('code-editor').value;
            const btn = document.getElementById('btn-submit');

            if (!name || !token) return alert("è¯·å¡«å†™å‡½æ•°åå’Œ Token");

            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å†™å…¥å› æœ...";

            try {
                // 1. è·å– log æ–‡ä»¶ SHA (ç”¨äºæ›´æ–°)
                let sha = null;
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (getRes.ok) sha = (await getRes.json()).sha;

                // 2. æ„é€  Commit
                const message = `${type} | ${name}\n\n${body}`;
                const content = btoa(`Updated at ${new Date().toISOString()}`);

                // 3. æ¨é€
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        content: content,
                        sha: sha
                    })
                });

                if (!putRes.ok) throw new Error((await putRes.json()).message);

                btn.innerText = "âœ… å†™å…¥æˆåŠŸ";
                // å»¶è¿Ÿ 2 ç§’è‡ªåŠ¨åˆ·æ–°ï¼Œç»™ GitHub ä¸€ç‚¹æ—¶é—´
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "âš¡ å†™å…¥å› æœ (Commit)";
                    syncUniverse();
                }, 2000);

            } catch (e) {
                alert("å†™å…¥å¤±è´¥: " + e.message);
                btn.disabled = false;
                btn.innerText = "âš¡ å†™å…¥å› æœ (Commit)";
            }
        }
    </script>
</body>
</html>
