<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Provelance v5.3 | Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
<style>
:root{--bg:#0d1117;--c:#161b22;--b:#30363d;--t:#c9d1d9;--a:#238636;--bl:#58a6ff;--r:#da3633;--g:#d29922}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{font-family:-apple-system,monospace;background:var(--bg);color:var(--t);margin:0;display:flex;flex-direction:column;height:100vh;overflow:hidden}
/* é¡¶éƒ¨é…ç½®æ¡ */
.top{background:#010409;border-bottom:1px solid var(--b);padding:8px;display:flex;gap:8px;z-index:9}
.in{background:#0d1117;border:1px solid var(--b);color:#fff;padding:6px;border-radius:4px;font-size:12px;flex:1;min-width:0}
.btn{background:var(--b);color:#fff;border:none;padding:6px 10px;border-radius:4px;font-size:12px;white-space:nowrap}
/* ä¸»è§†å›¾å®¹å™¨ */
.main{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}
.view{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;background:var(--bg)}
.view.act{display:flex}
/* åº•éƒ¨å¯¼èˆª */
.nav{height:50px;background:var(--c);border-top:1px solid var(--b);display:flex;justify-content:space-around;align-items:center}
.nav-i{display:flex;flex-direction:column;align-items:center;font-size:10px;color:#666;gap:2px}
.nav-i.on{color:var(--bl);font-weight:bold}
.nav-i span{font-size:18px}
/* 1. è§‚æµ‹é¡µ (Timeline) */
.tl{flex:1;overflow-y:auto;padding:10px}
.tc{background:var(--c);border:1px solid var(--b);border-radius:6px;margin-bottom:8px;font-size:12px}
.th{padding:8px;display:flex;justify-content:space-between;background:#ffffff05}
.tb{padding:10px;border-top:1px solid var(--b);white-space:pre-wrap;word-break:break-all;font-family:monospace;color:#8b949e;display:none}
.tb.open{display:block}
.st-box{height:150px;background:#000;border-top:1px solid var(--b);padding:10px;overflow:auto;font-family:monospace;color:var(--bl);font-size:11px}
/* 2. ç¼–è¾‘é¡µ (Editor) */
.toolbar{padding:8px;border-bottom:1px solid var(--b);display:flex;gap:5px;background:var(--c)}
.sel{background:var(--bg);border:1px solid var(--b);color:#fff;padding:6px;border-radius:4px}
#ed{flex:1;background:transparent;color:#e6edf3;border:none;padding:15px;font-family:'Consolas',monospace;font-size:14px;resize:none;line-height:1.5}
.act-bar{padding:10px;border-top:1px solid var(--b);display:flex;justify-content:space-between;align-items:center}
.commit{background:var(--a);color:#fff;border:none;padding:8px 20px;border-radius:4px;font-weight:bold}
.reg-list{max-height:120px;overflow-y:auto;border-bottom:1px solid var(--b);background:var(--c);display:none}
.reg-i{padding:8px 12px;border-bottom:1px solid var(--b);font-size:12px;color:var(--bl)}
/* çŠ¶æ€è‰²æ¡ */
.t-R{border-left:3px solid var(--bl)} .t-A{border-left:3px solid var(--a)} .t-E{border-left:3px solid var(--r)}
</style>
</head>
<body onload="brython();init()">

<div class="top">
    <input id="repo" class="in" placeholder="User/Repo" onchange="sv()">
    <input id="token" type="password" class="in" placeholder="Token" onchange="sv()">
    <button class="btn" onclick="sync()" id="s-btn">ğŸ”„ åŒæ­¥</button>
</div>

<div class="main">
    <div id="v-monitor" class="view act">
        <div class="tl" id="tl">
            <div style="text-align:center;color:#666;margin-top:50px">ç‚¹å‡»â€œåŒæ­¥â€è¿æ¥å®‡å®™</div>
        </div>
        <div style="padding:5px;background:var(--c);font-size:11px;color:#888">æœ€ç»ˆçŠ¶æ€ (STATE)</div>
        <div class="st-box"><pre id="st">{}</pre></div>
    </div>

    <div id="v-edit" class="view">
        <div class="reg-list" id="rl"></div>
        <div class="toolbar">
            <button class="btn" onclick="togReg()">ğŸ“œ æ³•åˆ™è¡¨</button>
            <select id="m-sel" class="sel" onchange="swM()" style="width:80px">
                <option value="ACTION">ğŸš€ è§¦å‘</option>
                <option value="RULE">âš–ï¸ å®šä¹‰</option>
            </select>
            <div style="flex:1;display:flex">
                <select id="r-sel" class="sel" style="flex:1;display:none" onchange="ldF()"></select>
                <input id="r-name" class="in" style="flex:1;display:none" placeholder="æ–°æ³•åˆ™å">
            </div>
        </div>
        <textarea id="ed" spellcheck="false" placeholder="åœ¨æ­¤è¾“å…¥ä»£ç ..."></textarea>
        <div class="act-bar">
            <span id="syn" style="font-size:12px;color:var(--a)">â— Ready</span>
            <button class="commit" id="c-btn" onclick="cmt()">âš¡ å†™å…¥å› æœ</button>
        </div>
    </div>
</div>

<div class="nav">
    <div class="nav-i on" onclick="tab('monitor')" id="n-mon"><span>ğŸ‘ï¸</span>è§‚æµ‹</div>
    <div class="nav-i" onclick="tab('edit')" id="n-edt"><span>âœï¸</span>æ’°å†™</div>
</div>

<script type="text/python">
from browser import window
import ast, traceback, sys

# ä¿®å¤ç‰ˆ MagicProxy: æ”¯æŒåŠ¨æ€å±æ€§èµ‹å€¼
class MagicProxy:
    def __init__(self, data):
        # å¿…é¡»ä½¿ç”¨ object.__setattr__ é¿å…æ— é™é€’å½’
        object.__setattr__(self, '_data', data)
    
    def __getattr__(self, k):
        # è¯»ä¸åˆ°è¿”å› None, ä¸æŠ¥é”™
        return self._data.get(k)
        
    def __setattr__(self, k, v):
        # å†™å…¥ç›´æ¥æ“ä½œå­—å…¸
        self._data[k] = v
        
    def __getitem__(self, k): return self._data.get(k)
    def __setitem__(self, k, v): self._data[k] = v

def py_run(code, state, params):
    try:
        s = MagicProxy(state)
        p = MagicProxy(params)
        # ç¼©è¿›ä»£ç 
        lines = ["    " + l for l in code.split('\n')]
        wrapper = "def logic(s, p, state, params):\n" + "\n".join(lines)
        env = {'s':s, 'p':p, 'state':state, 'params':params}
        exec(wrapper, env)
        res = env['logic'](s, p, state, params)
        return res if res is not None else state
    except Exception as e:
        try:
            return Exception(str(e)) # ç®€æ˜“æŠ¥é”™ï¼Œé˜²æ­¢ traceback åº“å´©æºƒ
        except:
            return Exception("Critical Error")

window.eng = {"run": py_run, "chk": lambda c: ast.parse(c) if c else True, "prs": ast.literal_eval}
</script>

<script>
let reg={}, LOG="universe.log";
function init(){
    let r=localStorage.getItem('pr'), t=localStorage.getItem('pt');
    if(r)document.getElementById('repo').value=r;
    if(t)document.getElementById('token').value=t;
    swM();
}
function sv(){
    localStorage.setItem('pr',document.getElementById('repo').value);
    localStorage.setItem('pt',document.getElementById('token').value);
}
function tab(w){
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('act'));
    document.getElementById('v-'+w).classList.add('act');
    document.querySelectorAll('.nav-i').forEach(e=>e.classList.remove('on'));
    document.getElementById(w=='monitor'?'n-mon':'n-edt').classList.add('on');
}
function togReg(){
    let d=document.getElementById('rl'); d.style.display=d.style.display=='block'?'none':'block';
}
function swM(){
    let m=document.getElementById('m-sel').value;
    let isA=m==='ACTION';
    document.getElementById('r-sel').style.display=isA?'block':'none';
    document.getElementById('r-name').style.display=isA?'none':'block';
    if(!isA) document.getElementById('ed').value="# s.x = p.y\nreturn s";
    else renSel();
}
function renSel(){
    let s=document.getElementById('r-sel'); s.innerHTML='';
    Object.keys(reg).forEach(k=>{let o=document.createElement('option');o.text=k;s.add(o)});
    ldF();
}
function ldF(){
    let k=document.getElementById('r-sel').value;
    if(!k || !reg[k]) return;
    // è‡ªåŠ¨ç”Ÿæˆå‚æ•°æ¨¡ç‰ˆ
    let c=reg[k], ps=new Set(), m;
    let r=/p\.([a-zA-Z0-9_]+)/g;
    while((m=r.exec(c))) ps.add(m[1]);
    let obj={}; ps.forEach(p=>obj[p]="");
    document.getElementById('ed').value = JSON.stringify(obj, null, 2).replace(/"/g, "'");
}
async function sync(){
    let rp=document.getElementById('repo').value, tk=document.getElementById('token').value;
    let btn=document.getElementById('s-btn');
    if(!rp||!tk)return alert('è¯·é…ç½®');
    btn.innerText="â³";
    try{
        // Fetch logic simplified for space
        let cms=[], pg=1, h={'Authorization':`token ${tk}`};
        while(true){
            let r=await fetch(`https://api.github.com/repos/${rp}/commits?per_page=100&page=${pg}`,{headers:h});
            let d=await r.json(); 
            if(!d.length)break; 
            cms=cms.concat(d); 
            if(d.length<100)break; 
            pg++;
        }
        cms.reverse();
        
        // Replay
        let st={}, tl=document.getElementById('tl'); tl.innerHTML=''; reg={};
        let rl=document.getElementById('rl'); rl.innerHTML='';
        
        for(let c of cms){
            let m=c.commit.message;
            if(!m.includes('|'))continue;
            let [hd, ...bd]=m.split('\n'), b=bd.join('\n').trim();
            let [ty, nm]=hd.split('|').map(s=>s.trim());
            let tm=new Date(c.commit.author.date).toLocaleTimeString().slice(0,5);
            
            let card=document.createElement('div'), resTxt="";
            card.className=`tc t-${ty.charAt(0)}`;
            
            if(ty==='RULE'){
                reg[nm]=b; resTxt=`å®šä¹‰: \n${b}`;
            }else{
                let p;
                try{ p=window.eng.prs(b) }catch(e){ p="ERR" }
                if(p==="ERR"){
                    resTxt=`å‚æ•°é”™è¯¯: ${b}`; card.className+=" t-E";
                }else{
                    let ret=window.eng.run(reg[nm]||"", st, p);
                    if(ret instanceof Error){
                        resTxt=`âŒ å¡Œç¼©: ${ret.message}\nArgs: ${b}`; card.className+=" t-E";
                    }else{
                        st=ret; resTxt=`âœ… OK\nArgs: ${b}`;
                    }
                }
            }
            card.innerHTML=`<div class="th" onclick="this.nextElementSibling.classList.toggle('open')"><span>${ty=='RULE'?'âš–ï¸':'ğŸš€'} ${nm}</span><span>${tm}</span></div><div class="tb">${resTxt}</div>`;
            tl.insertBefore(card, tl.firstChild);
        }
        
        document.getElementById('st').innerText=JSON.stringify(st,null,2);
        Object.keys(reg).forEach(k=>{
            let d=document.createElement('div');d.className='reg-i';d.innerText=k;
            d.onclick=()=>{
                tab('edit');document.getElementById('m-sel').value='RULE';swM();
                document.getElementById('r-name').value=k;
                document.getElementById('ed').value=reg[k];
            };
            rl.appendChild(d);
        });
        
        if(document.getElementById('m-sel').value==='ACTION') renSel();
        btn.innerText="ğŸ”„ åŒæ­¥";
        
    }catch(e){alert(e);btn.innerText="é‡è¯•"}
}

async function cmt(){
    let rp=document.getElementById('repo').value, tk=document.getElementById('token').value;
    let m=document.getElementById('m-sel').value, b=document.getElementById('ed').value;
    let n=m==='ACTION'?document.getElementById('r-sel').value:document.getElementById('r-name').value;
    let btn=document.getElementById('c-btn');
    
    if(!n)return alert('æ— åç§°');
    try{ if(m==='RULE')window.eng.chk(b); else window.eng.prs(b); }catch(e){return alert('è¯­æ³•é”™è¯¯');}
    
    btn.innerText="å†™å…¥..."; btn.disabled=true;
    try{
        let sha, r=await fetch(`https://api.github.com/repos/${rp}/contents/${LOG}`,{headers:{'Authorization':`token ${tk}`}});
        if(r.ok)sha=(await r.json()).sha;
        
        let res=await fetch(`https://api.github.com/repos/${rp}/contents/${LOG}`,{
            method:'PUT',
            headers:{'Authorization':`token ${tk}`,'Content-Type':'application/json'},
            body:JSON.stringify({message:`${m} | ${n}\n\n${b}`,content:btoa(`T:${Date.now()}`),sha:sha})
        });
        if(!res.ok)throw new Error(res.status);
        btn.innerText="âœ…"; setTimeout(()=>{btn.innerText="âš¡ å†™å…¥å› æœ";btn.disabled=false;sync()},1000);
    }catch(e){alert(e);btn.disabled=false}
}
</script>
</body>
</html>
