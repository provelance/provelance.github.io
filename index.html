<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Universe Observer v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .input-group { 
            background: #161b22; padding: 20px; border-radius: 6px; border: 1px solid #30363d; margin-bottom: 20px;
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        input { 
            background: #0d1117; color: #c9d1d9; border: 1px solid #30363d; padding: 8px; flex: 1; min-width: 200px;
            border-radius: 4px;
        }
        button { 
            background: #238636; color: #fff; border: none; padding: 8px 20px; cursor: pointer; font-weight: bold; border-radius: 4px;
        }
        button:hover { background: #2ea043; }
        
        /* ç»ˆç«¯é£æ ¼æ—¥å¿— */
        #log-container {
            background: #000; border: 1px solid #333; height: 200px; overflow-y: auto; padding: 10px;
            font-size: 12px; color: #8b949e; margin-bottom: 20px; border-radius: 4px;
        }
        .log-info { color: #58a6ff; }
        .log-success { color: #238636; }
        .log-error { color: #f85149; }
        .log-warn { color: #d29922; }

        /* çŠ¶æ€è¾“å‡º */
        pre { background: #161b22; padding: 15px; border-radius: 6px; overflow-x: auto; border: 1px solid #30363d; color: #a5d6ff; }
    </style>
</head>
<body onload="brython()">

<div class="container">
    <h1>ğŸª å®‡å®™å› æœè§‚æµ‹ç»ˆç«¯</h1>
    
    <div class="input-group">
        <input type="text" id="repoInput" placeholder="User/Repo (e.g., yourname/universe)" value="">
        <input type="password" id="tokenInput" placeholder="GitHub Token (å¯é€‰,ç”¨äºæé«˜APIé™é¢)">
        <button onclick="startInference()">å¯åŠ¨æ¨æ¼”</button>
    </div>

    <div id="log-container">ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…è¿æ¥å› æœé“¾...</div>
    
    <h3>æœ€ç»ˆçŠ¶æ€ (Current State):</h3>
    <pre id="output">{}</pre>
</div>

<script type="text/python">
from browser import window, console
import traceback

def execute_python_rule(user_code_str, state, params):
    # 1. è‡ªåŠ¨ç¼©è¿›ï¼šå°†ç”¨æˆ·çš„æ¯ä¸€è¡Œä»£ç éƒ½å‘å³ç¼©è¿› 4 ä¸ªç©ºæ ¼
    lines = user_code_str.split('\n')
    indented_lines = ['    ' + line for line in lines]
    indented_block = '\n'.join(indented_lines)

    # 2. æ„é€ åŒ…è£…å™¨ï¼šè‡ªåŠ¨åŠ ä¸Š def logic... å’Œé»˜è®¤çš„ return state
    # æˆ‘ä»¬åœ¨æœ€ååŠ ä¸€å¥ return stateï¼Œé˜²æ­¢ç”¨æˆ·å¿˜è®°å†™è¿”å›å€¼å¯¼è‡´ state å˜ None
    wrapped_code = f"""
def logic(state, params):
{indented_block}
    return state
"""

    # 3. è°ƒè¯•è¾“å‡ºï¼šåœ¨æ§åˆ¶å°æ‰“å°ç”Ÿæˆçš„å®Œæ•´ä»£ç ï¼ˆæ–¹ä¾¿æ’é”™ï¼‰
    # console.log("ç”Ÿæˆçš„ä»£ç :\n" + wrapped_code) 

    # 4. æ‰§è¡Œ
    loc = {}
    try:
        exec(wrapped_code, {}, loc)
        
        if 'logic' not in loc:
            raise Exception("é€»è¾‘åŒ…è£…å¤±è´¥")
            
        # è°ƒç”¨å‡½æ•°
        new_state = loc['logic'](state, params)
        
        # å†æ¬¡å…œåº•ï¼šå¦‚æœç”¨æˆ·æ˜¾å¼å†™äº† return ä½†æ²¡è¿”å›ä¸œè¥¿ï¼Œnew_state å¯èƒ½æ˜¯ None
        if new_state is None:
            return state
        return new_state
        
    except Exception as e:
        error_msg = f"{str(e)}\n{traceback.format_exc()}"
        console.error(error_msg)
        raise Exception(f"ä»£ç æ‰§è¡Œé”™è¯¯: {str(e)}")

window.execute_python_rule = execute_python_rule
</script>

<script>
    // æ—¥å¿—å·¥å…·
    function log(msg, type = 'info') {
        const div = document.getElementById('log-container');
        const line = document.createElement('div');
        line.className = `log-${type}`;
        line.textContent = `> ${msg}`;
        div.appendChild(line);
        div.scrollTop = div.scrollHeight;
    }

    // é€’å½’è·å–æ‰€æœ‰ Commitï¼ˆè§£å†³ Bug 1ï¼‰
    async function fetchAllCommits(repo, token) {
        let commits = [];
        let page = 1;
        const headers = token ? { 'Authorization': `token ${token}` } : {};

        while (true) {
            log(`æ­£åœ¨æ‹‰å–å†å²è®°å½•ç¬¬ ${page} é¡µ...`);
            const url = `https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`;
            const res = await fetch(url, { headers });
            
            if (!res.ok) {
                if (res.status === 403) throw new Error("API é€Ÿç‡é™åˆ¶ã€‚è¯·å¡«å†™ Token æˆ–ç¨åå†è¯•ã€‚");
                if (res.status === 404) throw new Error("æ‰¾ä¸åˆ°ä»“åº“ï¼Œè¯·æ£€æŸ¥æ‹¼å†™æˆ–æƒé™ã€‚");
                throw new Error(`GitHub API Error: ${res.status}`);
            }

            const data = await res.json();
            if (data.length === 0) break; // æ²¡æœ‰æ›´å¤šæ•°æ®äº†
            
            commits = commits.concat(data);
            if (data.length < 100) break; // ä¸è¶³100æ¡è¯´æ˜æ˜¯æœ€åä¸€é¡µ
            page++;
        }
        return commits;
    }

    async function startInference() {
        const repo = document.getElementById('repoInput').value.trim();
        const token = document.getElementById('tokenInput').value.trim();
        const output = document.getElementById('output');
        
        document.getElementById('log-container').innerHTML = ''; // æ¸…ç©ºæ—¥å¿—
        output.textContent = "æ¨æ¼”ä¸­...";

        if (!repo) return log("é”™è¯¯: è¯·è¾“å…¥ä»“åº“åœ°å€", "error");

        try {
            // 1. è·å–å®Œæ•´å†å²
            let commits = await fetchAllCommits(repo, token);
            log(`å› æœé“¾æ‹‰å–å®Œæˆï¼Œå…± ${commits.length} ä¸ªèŠ‚ç‚¹ã€‚`, "success");
            
            // 2. æŒ‰æ—¶é—´æ­£åºæ’åˆ— (Oldest -> Newest)
            commits.reverse();

            // 3. è™šæ‹Ÿæœºåˆå§‹åŒ–
            let state = {}; 
            const registry = {}; 

            // 4. é€ä¸ªå›æ”¾
            for (const item of commits) {
                const fullMsg = item.commit.message;
                
                // è§£å†³ Bug 2: æ›´å¥å£®çš„åˆ†å‰²é€»è¾‘
                // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ¢è¡Œç¬¦
                const splitIndex = fullMsg.indexOf('\n');
                let title, body;
                
                if (splitIndex === -1) {
                    title = fullMsg;
                    body = "";
                } else {
                    title = fullMsg.substring(0, splitIndex).trim();
                    body = fullMsg.substring(splitIndex).trim();
                }

                if (!title.includes('|')) continue; // è·³è¿‡æ™®é€š Commit

                const [type, funcName] = title.split('|').map(s => s.trim());

                if (type === 'RULE') {
                    if (!body) {
                        log(`è·³è¿‡ç©ºè§„åˆ™: ${funcName}`, "warn");
                        continue;
                    }
                    registry[funcName] = body; // å­˜å‚¨ Python æºç 
                    log(`[RULE] å®šä¹‰é€»è¾‘: ${funcName}`, "info");
                } 
                else if (type === 'ACTION') {
                    if (!registry[funcName]) {
                        throw new Error(`å°è¯•è°ƒç”¨æœªå®šä¹‰çš„å‡½æ•°: ${funcName} (Commit: ${item.sha.substring(0,7)})`);
                    }
                    
                    log(`[ACTION] æ‰§è¡Œ: ${funcName}`, "success");
                    const params = body ? JSON.parse(body) : {};
                    
                    // è°ƒç”¨ Python å¼•æ“
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ·±æ‹·è´ stateï¼Œé˜²æ­¢å¼•ç”¨æ±¡æŸ“ï¼ˆè™½ç„¶ JSON è½¬æ¢æœ¬èº«å°±æ˜¯æ·±æ‹·è´ï¼‰
                    state = window.execute_python_rule(registry[funcName], state, params);
                }
            }

            // 5. è¾“å‡ºç»“æœ
            output.textContent = JSON.stringify(state, null, 4);
            log("å®‡å®™å½“å‰çŠ¶æ€å·²åŒæ­¥ã€‚", "success");

        } catch (err) {
            log(err.message, "error");
            output.textContent = JSON.stringify({ ERROR: err.message }, null, 4);
        }
    }
</script>

</body>
</html>
