<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Provelance å®‡å®™å› æœæ§åˆ¶ç»ˆç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --red: #da3633; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Consolas", monospace; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* å“åº”å¼å¯¼èˆª */
        .navbar { background: #010409; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .logo { font-weight: bold; font-size: 14px; white-space: nowrap; }
        .logo span { color: var(--accent); }
        .config-area { flex: 1; display: flex; gap: 5px; min-width: 280px; }
        input.config { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px; border-radius: 4px; flex: 1; font-size: 12px; }
        button.connect-btn { background: var(--border); color: var(--text); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 12px; }

        /* å“åº”å¼ä¸»å¸ƒå±€ */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        @media (max-width: 850px) { .main-layout { flex-direction: column; overflow: auto; } }

        .panel { display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--bg); }
        .panel-header { padding: 10px; font-size: 11px; font-weight: bold; color: #8b949e; background: #161b22; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }

        /* ä¾§è¾¹æ å®½åº¦æ§åˆ¶ */
        .panel-registry { width: 200px; }
        .panel-editor { flex: 1; min-width: 350px; }
        .panel-timeline { width: 350px; border-right: none; }
        @media (max-width: 850px) { .panel-registry, .panel-editor, .panel-timeline { width: 100%; min-width: 0; border-right: none; border-bottom: 1px solid var(--border); } .panel-timeline { height: 500px; } }

        /* æ³•åˆ™åˆ—è¡¨ */
        .rule-item { padding: 8px 12px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; transition: 0.2s; }
        .rule-item:hover { background: var(--card); color: var(--blue); }

        /* ç¼–è¾‘å™¨åŒºåŸŸ */
        .editor-container { display: flex; flex-direction: column; height: 100%; background: #0d1117; }
        .toolbar { padding: 10px; display: flex; gap: 8px; border-bottom: 1px solid var(--border); background: var(--card); }
        select, .name-input { background: var(--bg); border: 1px solid var(--border); color: white; padding: 6px; border-radius: 4px; font-size: 13px; }
        #code-editor { flex: 1; background: transparent; color: #e6edf3; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; min-height: 200px; }
        .footer-bar { padding: 10px; border-top: 1px solid var(--border); background: var(--card); display: flex; justify-content: space-between; align-items: center; }

        /* æ—¶é—´çº¿å¢å¼º */
        .timeline-scroll { flex: 1; overflow-y: auto; background: #010409; padding: 10px; }
        .timeline-item { border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; background: var(--card); }
        .t-head { padding: 8px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; }
        .t-body { display: none; padding: 10px; background: #000; border-top: 1px solid var(--border); font-size: 12px; }
        .active { display: block; }
        .type-RULE { border-left: 4px solid var(--blue); }
        .type-ACTION { border-left: 4px solid var(--accent); }
        .type-ERROR { border-left: 4px solid var(--red); }
        pre.code { margin: 0; white-space: pre-wrap; word-break: break-all; color: #8b949e; font-size: 11px; }

        /* çŠ¶æ€çœ‹æ¿ */
        .state-view { height: 180px; background: #000; border-top: 2px solid var(--border); padding: 10px; overflow: auto; font-size: 12px; color: #a5d6ff; }
        
        /* äº¤äº’å…ƒç´  */
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-main:disabled { opacity: 0.5; }
    </style>
</head>
<body onload="brython(); init();">

    <div class="navbar">
        <div class="logo">ğŸŒŒ <span id="universe-name">å¾…å®š</span> å®‡å®™ç»ˆç«¯</div>
        <div class="config-area">
            <input type="text" id="repo" class="config" placeholder="ç”¨æˆ·/ä»“åº“" oninput="updateUniverseName()">
            <input type="password" id="token" class="config" placeholder="Token">
            <button class="connect-btn" onclick="syncUniverse()">ğŸ”Œ åŒæ­¥</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="panel panel-registry">
            <div class="panel-header">æ³•åˆ™ (REGISTRY)</div>
            <div id="rule-list" class="panel-body"></div>
        </div>

        <div class="panel panel-editor">
            <div class="editor-container">
                <div class="toolbar">
                    <select id="commit-type" onchange="onTypeChange()">
                        <option value="ACTION">ğŸš€ è§¦å‘åŠ¨ä½œ</option>
                        <option value="RULE">âš–ï¸ å®šä¹‰æ³•åˆ™</option>
                    </select>
                    <div id="name-container" style="flex:1; display:flex;">
                        <select id="action-selector" class="name-input" style="flex:1; display:none;"></select>
                        <input type="text" id="rule-input" class="name-input" style="flex:1;" placeholder="å‡½æ•°å">
                    </div>
                </div>
                <textarea id="code-editor"></textarea>
                <div class="footer-bar">
                    <small id="status-text" style="opacity:0.5; font-size:10px;">å°±ç»ª</small>
                    <button id="btn-submit" class="btn-main" onclick="commit()">âš¡ å†™å…¥å› æœ</button>
                </div>
            </div>
        </div>

        <div class="panel panel-timeline">
            <div class="panel-header">æ¼”åŒ–å² (TIMELINE)</div>
            <div id="timeline" class="timeline-scroll"></div>
            <div class="panel-header">è§‚æµ‹æ€ (STATE)</div>
            <div class="state-view">
                <pre id="final-state">{}</pre>
            </div>
        </div>
    </div>

    <script type="text/python">
    from browser import window
    import ast, traceback, sys

    def parse_params(s):
        if not s or not s.strip(): return {}
        try: return ast.literal_eval(s)
        except: return None

    def execute_logic(code, state, params):
        wrapped = f"def logic(state, params):\n" + "\n".join(["    " + l for l in code.split('\n')]) + "\n    return state"
        loc = {}
        try:
            exec(wrapped, {}, loc)
            return loc['logic'](state, params)
        except:
            etype, value, tb = sys.exc_info()
            return Exception("".join(traceback.format_exception(etype, value, tb)))

    window.python_engine = {"parse": parse_params, "run": execute_logic}
    </script>

    <script>
        let registry = {};
        const LOG_FILE = "universe.log";

        function init() {
            document.getElementById('repo').value = localStorage.getItem('provelance_repo') || '';
            document.getElementById('token').value = localStorage.getItem('provelance_token') || '';
            updateUniverseName();
            onTypeChange();
        }

        function updateUniverseName() {
            const val = document.getElementById('repo').value;
            document.getElementById('universe-name').innerText = val ? val.split('/').pop() : 'å¾…å®š';
        }

        function onTypeChange() {
            const type = document.getElementById('commit-type').value;
            const actionSelect = document.getElementById('action-selector');
            const ruleInput = document.getElementById('rule-input');
            const editor = document.getElementById('code-editor');

            if (type === 'ACTION') {
                actionSelect.style.display = 'block';
                ruleInput.style.display = 'none';
                updateActionDropdown();
                editor.value = "{\n    'key': 'value'\n}";
            } else {
                actionSelect.style.display = 'none';
                ruleInput.style.display = 'block';
                editor.value = "return state";
            }
        }

        function updateActionDropdown() {
            const select = document.getElementById('action-selector');
            select.innerHTML = '';
            Object.keys(registry).forEach(name => {
                const opt = document.createElement('option');
                opt.value = opt.text = name;
                select.appendChild(opt);
            });
        }

        async function syncUniverse() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            if(!repo) return;
            localStorage.setItem('provelance_repo', repo);
            localStorage.setItem('provelance_token', token);

            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '<div style="text-align:center; padding:20px; font-size:12px;">åŒæ­¥ä¸­...</div>';

            try {
                let commits = [];
                let page = 1;
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, { headers });
                    const data = await res.json();
                    if(!data.length) break;
                    commits = commits.concat(data);
                    if(data.length < 100) break;
                    page++;
                }
                commits.reverse();

                let state = {};
                registry = {};
                timeline.innerHTML = '';
                
                for(const item of commits) {
                    const msg = item.commit.message;
                    const [head, ...bodyArr] = msg.split('\n');
                    const body = bodyArr.join('\n').trim();
                    if(!head.includes('|')) continue;
                    
                    const [type, funcName] = head.split('|').map(s => s.trim());
                    const card = document.createElement('div');
                    card.className = `timeline-item type-${type}`;
                    
                    let html = `<div class="t-head" onclick="this.nextElementSibling.classList.toggle('active')">
                                    <span>${type === 'RULE' ? 'âš–ï¸' : 'ğŸš€'} ${funcName}</span>
                                    <small style="opacity:0.5">${new Date(item.commit.author.date).toLocaleTimeString()}</small>
                                </div><div class="t-body">`;

                    if(type === 'RULE') {
                        registry[funcName] = body;
                        html += `<pre class="code">${body}</pre>`;
                    } else {
                        const params = window.python_engine.parse(body);
                        const result = window.python_engine.run(registry[funcName] || "", state, params);
                        if(result instanceof Error) {
                            card.className += ' type-ERROR';
                            html += `<div style="color:var(--red)">å¡Œç¼©: ${result.message}</div><pre class="code">${body}</pre>`;
                        } else {
                            state = result;
                            html += `<pre class="code">å‚æ•°: ${body}</pre>`;
                        }
                    }
                    card.innerHTML = html + `</div>`;
                    timeline.insertBefore(card, timeline.firstChild);
                }

                document.getElementById('final-state').innerText = JSON.stringify(state, null, 2);
                const ruleList = document.getElementById('rule-list');
                ruleList.innerHTML = '';
                Object.keys(registry).reverse().forEach(name => {
                    const d = document.createElement('div');
                    d.className = 'rule-item';
                    d.innerText = name;
                    d.onclick = () => {
                        document.getElementById('commit-type').value = 'RULE';
                        document.getElementById('rule-input').value = name;
                        document.getElementById('code-editor').value = registry[name];
                        onTypeChange();
                    };
                    ruleList.appendChild(d);
                });
                updateActionDropdown();
                document.getElementById('status-text').innerText = "åŒæ­¥å®Œæˆ";
            } catch(e) {
                alert("åŒæ­¥å¤±è´¥: " + e.message);
            }
        }

        async function commit() {
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            const type = document.getElementById('commit-type').value;
            const name = type === 'ACTION' ? document.getElementById('action-selector').value : document.getElementById('rule-input').value;
            const body = document.getElementById('code-editor').value;
            const btn = document.getElementById('btn-submit');

            if(!name || !token) return alert("ä¿¡æ¯ä¸å…¨");
            btn.disabled = true;
            btn.innerText = "...";

            try {
                let sha = null;
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, { headers: {'Authorization': `token ${token}`} });
                if(getRes.ok) sha = (await getRes.json()).sha;

                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT',
                    headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: `${type} | ${name}\n\n${body}`, content: btoa(`T: ${Date.now()}`), sha: sha })
                });

                if(!res.ok) throw new Error("å†™å…¥å¤±è´¥");
                btn.innerText = "âœ…";
                setTimeout(() => { btn.disabled = false; btn.innerText = "âš¡ å†™å…¥å› æœ"; syncUniverse(); }, 1500);
            } catch(e) {
                alert(e.message);
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
