<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Provelance v8.2 - Full Spectrum</title>
<script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"></script>
<style>
:root{--bg:#0d1117;--c:#161b22;--b:#30363d;--t:#c9d1d9;--a:#238636;--bl:#58a6ff;--r:#da3633;--purp:#bc8cff;--y:#d29922}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:-apple-system,system-ui,monospace}
html,body{height:100%;margin:0;padding:0;overflow:hidden;background:var(--bg);color:var(--t)}
body{display:flex;flex-direction:column;height:100dvh}
.top{background:#010409;border-bottom:1px solid var(--b);padding:8px 12px;display:flex;gap:6px;align-items:center;flex-shrink:0}
.in{background:#0d1117;border:1px solid var(--b);color:#fff;padding:6px 10px;border-radius:6px;font-size:13px;flex:1;min-width:0}
.btn-s{background:var(--bl);color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:bold}
.nav{height:65px;background:var(--c);border-top:2px solid var(--b);display:flex;flex-shrink:0;padding-bottom:env(safe-area-inset-bottom)}
.nav-i{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:#888;gap:4px}
.nav-i.on{color:var(--bl);background:#58a6ff11}
.main{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg)}
.view.act{display:flex}
.tl{flex:1;overflow-y:auto;padding:12px;overscroll-behavior:contain}
.tc{background:var(--c);border:1px solid var(--b);border-radius:8px;margin-bottom:10px;font-size:13px;border-left:4px solid transparent}
.th{padding:12px;display:flex;justify-content:space-between;align-items:center}
.tb{padding:12px;border-top:1px solid var(--b);background:#00000033;font-size:12px;display:none;flex-direction:column;gap:10px}
.tb-sec{background:#ffffff0a;padding:8px;border-radius:4px;position:relative;border-left:2px solid var(--b)}
.tb-pre{margin:5px 0 0 0;white-space:pre-wrap!important;word-break:break-all!important;color:#8b949e;max-height:200px;overflow-y:auto;font-size:11px}
.cp-btn{position:absolute;top:5px;right:5px;background:var(--b);color:#ccc;border:none;padding:4px 8px;border-radius:4px;font-size:10px;z-index:5}
.diff-row{display:flex;justify-content:space-between;padding:2px 0;font-family:monospace;border-bottom:1px solid #ffffff05}
.diff-k{color:#8b949e}
.diff-v{display:flex;gap:8px;align-items:center;max-width:70%;overflow:hidden}
.v-old{text-decoration:line-through;opacity:0.4;white-space:nowrap}
.v-new.up{color:var(--a);font-weight:bold}
.v-new.down{color:var(--r);font-weight:bold}
.v-new.add{color:var(--bl)}
.form-card{background:#1c2128;border:1px solid var(--purp);margin:12px;border-radius:8px;padding:12px;display:none;flex-direction:column;gap:10px}
.form-row{display:flex;align-items:center;gap:10px}
.form-label{font-size:11px;color:var(--purp);width:70px;font-weight:bold}
.st-box{height:25%;max-height:180px;background:#000;border-top:1px solid var(--b);padding:10px;overflow:auto;font-size:12px;color:var(--bl);flex-shrink:0}

/* === æ ¸å¿ƒä¿®å¤ï¼šç¼–è¾‘å™¨æ ·å¼ === */
.editor-container{flex:1;position:relative;overflow:hidden;background:#000}

/* ç»Ÿä¸€å­—ä½“æ ˆå’Œæ’ç‰ˆå±æ€§ï¼Œç¡®ä¿åƒç´ çº§å¯¹é½ */
#ed, #hl-pre, #hl-code {
    margin: 0;
    padding: 16px;
    font-size: 14px; /* ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œå¢å¼ºç§»åŠ¨ç«¯å¯è¯»æ€§ */
    line-height: 1.5;
    /* å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šçš„ç­‰å®½å­—ä½“æ ˆï¼Œé¿å… textarea å’Œ pre æ¸²æŸ“ä¸ä¸€è‡´ */
    font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace !important;
    /* ç»Ÿä¸€ Tab å¤§å°ï¼Œè§£å†³ç¼©è¿›å¯¼è‡´çš„é”™ä½ */
    tab-size: 4 !important;
    -moz-tab-size: 4 !important;
    /* ç»Ÿä¸€æ¢è¡Œè§„åˆ™ */
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    /* ç¦ç”¨è¿å­—å’Œè‡ªåŠ¨è°ƒæ•´ï¼Œé˜²æ­¢å­—ç¬¦å®½åº¦å˜åŒ– */
    font-variant-ligatures: none;
    letter-spacing: 0 !important;
}

#ed {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    color: transparent; /* æ–‡æœ¬é€æ˜ */
    caret-color: #fff; /* å…‰æ ‡ç™½è‰² */
    z-index: 2;
    resize: none;
    overflow-y: auto;
    border: none;
    outline: none;
    /* ç§»é™¤æ–‡æœ¬é˜´å½±ï¼Œé˜²æ­¢é€æ˜æ–‡å­—äº§ç”Ÿé¬¼å½± */
    text-shadow: none !important;
    -webkit-text-fill-color: transparent;
}

/* è§£å†³åŒå½±é—®é¢˜ï¼šé€‰ä¸­æ—¶å¼ºåˆ¶æ–‡æœ¬é¢œè‰²ä¿æŒé€æ˜ï¼Œåªæ˜¾ç¤ºèƒŒæ™¯è‰² */
#ed::selection {
    background: rgba(88, 166, 255, 0.3); /* åŠé€æ˜è“è‰²èƒŒæ™¯ */
    color: transparent;
    -webkit-text-fill-color: transparent;
}

#hl-pre {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    background: transparent;
    pointer-events: none;
    overflow: hidden; /* æ»šåŠ¨ç”± textarea æ¥ç®¡ */
}

#hl-code {
    display: block;
    color: #e6edf3;
}

.toolbar{background:var(--c);padding:12px;border-bottom:1px solid var(--b);flex-shrink:0}
.reg-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:10px;margin-bottom:10px;scrollbar-width:none}
.reg-tag{background:var(--b);padding:5px 12px;border-radius:15px;font-size:12px;white-space:nowrap;color:var(--bl);border:1px solid #444}
.act-bar{padding:12px;background:var(--c);border-top:1px solid var(--b);display:flex;justify-content:space-between;align-items:center}
.t-R{border-left-color:var(--bl)} .t-A{border-left-color:var(--a)} .t-E{border-left-color:var(--r)}

/* Prism æ ·å¼è¦†ç›– */
pre[class*="language-"]{margin:0;padding:0;background:transparent!important;overflow:visible!important}
code[class*="language-"]{text-shadow:none!important;font-family:inherit!important}
</style>
</head>
<body onload="brython();init()">
<div class="top">
    <input id="repo" class="in" placeholder="Repo" onchange="sv()">
    <input id="token" type="password" class="in" placeholder="Token" onchange="sv()">
    <button class="btn-s" onclick="sync()" id="s-btn">åŒæ­¥</button>
</div>
<div class="main">
    <div id="v-monitor" class="view act"><div class="tl" id="tl"></div><div class="st-box"><pre id="st" style="margin:0">{}</pre></div></div>
    <div id="v-edit" class="view">
        <div class="toolbar">
            <div class="reg-scroll" id="rl-scroll"></div>
            <div style="display:flex;gap:8px">
                <select id="m-sel" class="in" style="flex:0.4;font-weight:bold" onchange="swM()"><option value="ACTION">ğŸš€ è§¦å‘</option><option value="RULE">âš–ï¸ å®šä¹‰</option></select>
                <select id="r-sel" class="in" onchange="ldF()"></select><input id="r-name" class="in" style="display:none" placeholder="åç§°">
            </div>
        </div>
        <div id="smart-form" class="form-card"></div>
        <div class="editor-container">
            <pre id="hl-pre" class="language-python"><code id="hl-code" class="language-python"></code></pre>
            <textarea id="ed" spellcheck="false" oninput="onEdInp()" onscroll="onEdScr()"></textarea>
        </div>
        <div class="act-bar"><span id="syn" style="color:var(--a);font-size:12px;font-weight:bold">â— å°±ç»ª</span><button onclick="cmt()" id="c-btn" style="background:var(--a);color:#fff;border:none;padding:12px 35px;border-radius:8px;font-weight:bold;font-size:15px">âš¡ å†™å…¥</button></div>
    </div>
</div>
<div class="nav"><div class="nav-i on" onclick="tab('monitor')" id="n-mon"><b>ğŸ‘ï¸</b>è§‚æµ‹</div><div class="nav-i" onclick="tab('edit')" id="n-edt"><b>âœï¸</b>æ’°å†™</div></div>

<script type="text/python">
from browser import window
import ast

def clean_data(obj):
    if isinstance(obj, dict): return {str(k): clean_data(v) for k, v in obj.items()}
    elif isinstance(obj, list) or hasattr(obj, 'append'): return [clean_data(x) for x in list(obj)]
    elif isinstance(obj, (int, float, str, bool)) or obj is None: return obj
    elif hasattr(obj, 'to_dict'): return clean_data(obj.to_dict())
    else: return str(obj)

class StateProxy:
    def __init__(self, d): self._d = d if isinstance(d, dict) else dict(d)
    def __getattr__(self, k):
        if k == 'get': return self._d.get
        return self._d.get(k, 0)
    def __setattr__(self, k, v):
        if k == '_d': object.__setattr__(self, k, v)
        else: self._d[k] = v

def py_run(code, state_in, params_in):
    try:
        s, p = StateProxy(clean_data(state_in)), StateProxy(clean_data(params_in))
        exec(code, {'s':s,'p':p,'int':int,'float':float,'round':round,'abs':abs,'max':max,'min':min,'list':list,'dict':dict})
        return clean_data(s._d)
    except Exception as e: return str(e)

def get_schema(code):
    try:
        tree, params, aliases = ast.parse(code), {}, {}
        for node in ast.walk(tree):
            if isinstance(node, ast.Assign):
                v = node.value
                if isinstance(v, ast.Attribute) and getattr(v.value,'id','')=='p':
                    for t in node.targets:
                        if isinstance(t, ast.Name): aliases[t.id] = v.attr
            if isinstance(node, ast.Attribute) and getattr(node.value,'id','')=='p':
                if node.attr not in params: params[node.attr] = set()
            if isinstance(node, ast.Compare):
                p_name = None
                if isinstance(node.left, ast.Attribute) and getattr(node.left.value,'id','')=='p': p_name = node.left.attr
                elif isinstance(node.left, ast.Name) and node.left.id in aliases: p_name = aliases[node.left.id]
                if p_name:
                    if p_name not in params: params[p_name] = set()
                    for op, cp in zip(node.ops, node.comparators):
                        if isinstance(op, (ast.Eq, ast.In)):
                            if isinstance(cp, ast.Constant): params[p_name].add(str(cp.value))
                            elif isinstance(cp, (ast.List, ast.Tuple)):
                                for e in cp.elts:
                                    if isinstance(e, ast.Constant): params[p_name].add(str(e.value))
        return {k: sorted(list(v)) for k, v in params.items()}
    except: return {}

window.eng = {"run":py_run, "prs":lambda b:ast.literal_eval(b), "get_schema":get_schema}
</script>

<script>
let reg={}, LOG="universe.log";
function init(){
    let r=localStorage.getItem('pr'), t=localStorage.getItem('pt');
    if(r)document.getElementById('repo').value=r;
    if(t)document.getElementById('token').value=t;
    swM();
}
function sv(){localStorage.setItem('pr',document.getElementById('repo').value);localStorage.setItem('pt',document.getElementById('token').value)}
function tab(w){document.querySelectorAll('.view').forEach(e=>e.classList.remove('act'));document.getElementById('v-'+w).classList.add('act');document.querySelectorAll('.nav-i').forEach(e=>e.classList.remove('on'));document.getElementById(w=='monitor'?'n-mon':'n-edt').classList.add('on')}

function onEdInp(){
    let area = document.getElementById('ed'), code = document.getElementById('hl-code');
    // å…³é”®ä¿®æ­£ï¼šç¡®ä¿å°¾éƒ¨æ¢è¡Œç¬¦å¤„ç†ä¸€è‡´ï¼Œå¦åˆ™å…‰æ ‡åœ¨æœ€åä¸€è¡Œä¼šè·³åŠ¨
    let txt = area.value;
    if(txt.endsWith('\n')) txt += ' '; 
    code.textContent = txt;
    Prism.highlightElement(code);
}
function onEdScr(){
    let area = document.getElementById('ed'), pre = document.getElementById('hl-pre');
    pre.scrollTop = area.scrollTop;
    pre.scrollLeft = area.scrollLeft;
}

function swM(){
    let m=document.getElementById('m-sel').value;
    document.getElementById('r-sel').style.display=m==='ACTION'?'block':'none';
    document.getElementById('r-name').style.display=m==='RULE'?'block':'none';
    document.getElementById('smart-form').style.display=m==='ACTION'?'flex':'none';
    if(m==='ACTION')renSel(); else { document.getElementById('ed').value=""; onEdInp(); }
}
function renSel(){
    let s=document.getElementById('r-sel');s.innerHTML='';
    Object.keys(reg).sort().forEach(k=>{let o=document.createElement('option');o.text=k;s.add(o)});
    ldF();
}
function ldF(){
    let k=document.getElementById('r-sel').value; if(!k||!reg[k])return;
    let schema = window.eng.get_schema(reg[k]), f = document.getElementById('smart-form'); f.innerHTML='';
    Object.keys(schema).forEach(pName => {
        let row = document.createElement('div'); row.className='form-row';
        let lbl = document.createElement('div'); lbl.className='form-label'; lbl.innerText=pName;
        let input;
        if(schema[pName].length > 0){
            input = document.createElement('select'); input.className='in';
            let empty = document.createElement('option'); empty.text="-- é€‰æ‹© --"; empty.value=""; input.add(empty);
            schema[pName].forEach(opt => { let o=document.createElement('option'); o.text=opt; o.value=opt; input.add(o)});
        } else { input = document.createElement('input'); input.className='in'; input.placeholder='...'; }
        input.onchange = () => syncFormToCode();
        input.dataset.pname = pName;
        row.appendChild(lbl); row.appendChild(input); f.appendChild(row);
    });
    syncFormToCode();
}
function syncFormToCode(){
    if(document.getElementById('m-sel').value !== 'ACTION') return;
    let params = {};
    document.querySelectorAll('#smart-form .in').forEach(i => {
        let val = i.value; if(val === "") return;
        if(!isNaN(val) && val.trim()!=='') val = parseFloat(val);
        params[i.dataset.pname] = val;
    });
    document.getElementById('ed').value = JSON.stringify(params, null, 2).replace(/"/g, "'");
    onEdInp();
}
function cp(btn, txt) { navigator.clipboard.writeText(txt).then(()=>{let raw=btn.innerText;btn.innerText="å·²å¤åˆ¶!";setTimeout(()=>btn.innerText=raw,1500)}) }

function getDiffHtml(oldS, newS) {
    try {
        let html = '<div style="padding:4px 0">';
        const keys = new Set([...Object.keys(oldS||{}), ...Object.keys(newS||{})]);
        let changed = false;
        keys.forEach(k => {
            let ov = oldS?oldS[k]:undefined, nv = newS?newS[k]:undefined;
            if (JSON.stringify(ov) === JSON.stringify(nv)) return;
            changed = true;
            let dOld = Array.isArray(ov) ? `[${ov.length}]` : (typeof ov === 'object' ? '{...}' : ov);
            let dNew = Array.isArray(nv) ? `[${nv.length}]` : (typeof nv === 'object' ? '{...}' : nv);
            let cls = 'add', sym = '';
            if (typeof ov === 'number' && typeof nv === 'number') { cls = nv > ov ? 'up' : 'down'; sym = nv > ov ? 'â–²' : 'â–¼'; }
            html += `<div class="diff-row"><span class="diff-k">${k}</span><span class="diff-v"><span class="v-old">${ov!==undefined?dOld:''}</span><span class="v-new ${cls}">${sym} ${dNew}</span></span></div>`;
        });
        return changed ? html + '</div>' : '<div style="color:#555;font-size:11px">æ— å˜åŠ¨</div>';
    } catch(e) { return '<div style="color:var(--r)">Diff Error</div>'; }
}

async function sync(){
    let rp=document.getElementById('repo').value,tk=document.getElementById('token').value,btn=document.getElementById('s-btn');
    if(!rp||!tk)return; btn.innerText="..."; btn.disabled=true;
    try{
        let cms=[], pg=1, h={'Authorization':`token ${tk}`};
        while(true){let r=await fetch(`https://api.github.com/repos/${rp}/commits?per_page=100&page=${pg}`,{headers:h});let d=await r.json();if(!d||!d.length)break;cms=cms.concat(d);if(d.length<100)break;pg++}
        cms.reverse();
        
        let tl=document.getElementById('tl'); tl.innerHTML=''; reg={};
        let sc=document.getElementById('rl-scroll'); sc.innerHTML='';
        let st={};

        let validCms = cms.filter(c => c.commit.message.includes('|'));
        
        if(validCms.length === 0) {
            tl.innerHTML = `
                <div style="padding:20px; color:#8b949e; line-height:1.6; border:1px dashed var(--b); border-radius:12px; margin:10px; background:#161b22">
                    <h3 style="color:var(--bl); margin-top:0">ğŸŒŒ å®‡å®™å¤§çˆ†ç‚¸æŒ‡å¼•</h3>
                    <p style="font-size:13px">æ£€æµ‹åˆ°è™šç©ºä»“åº“ã€‚è¯·é€šè¿‡ä»¥ä¸‹æ­¥éª¤å»ºç«‹<b>äº¤äº’å¾‹</b>ï¼š</p>
                    <div style="background:#000; padding:12px; border-radius:8px; font-size:11px; border:1px solid var(--b)">
                        <b style="color:var(--purp)">1. å®šä¹‰è§„åˆ™ (RULE):</b><br>
                        åç§°: <span style="color:var(--y)">power_system</span><br>
                        ä»£ç :<br>
                        <code style="color:var(--a)">
                        s.energy = getattr(s, 'energy', 0) + p.gain<br>
                        s.last_action = f"æ³¨å…¥èƒ½é‡: {p.gain}"
                        </code>
                    </div>
                    <p style="font-size:13px; margin-top:15px">è¯´æ˜ï¼š</p>
                    <ul style="padding-left:18px; font-size:12px; color:#c9d1d9">
                        <li><b style="color:var(--bl)">s.energy</b>: çŠ¶æ€å¯¹è±¡ï¼Œæ•°æ®ä¼šæ°¸ä¹…ä¿å­˜ã€‚</li>
                        <li><b style="color:var(--bl)">p.gain</b>: å‚æ•°å¯¹è±¡ï¼Œå†™å…¥æ—¶é€šè¿‡è¡¨å•è¾“å…¥ã€‚</li>
                    </ul>
                    <div style="margin-top:10px; font-size:11px; color:#666">å®Œæˆåç‚¹å‡»â€œå†™å…¥â€ï¼Œç„¶åå›åˆ°â€œè§¦å‘â€æ¨¡å¼è¾“å…¥æ•°å€¼ã€‚</div>
                </div>`;
            document.getElementById('st').innerText="{}";
            btn.innerText="åŒæ­¥"; btn.disabled=false;
            return;
        }

        for(let c of validCms){
            let m=c.commit.message;
            let [hd, ...bd]=m.split('\n'), b=bd.join('\n').trim(), [ty, nm]=hd.split('|').map(s=>s.trim());
            let card=document.createElement('div'), resHtml="", codeStr="";
            card.className=`tc t-${ty.charAt(0)}`;
            if(ty==='RULE'){ 
                reg[nm]=b; 
                resHtml=`<div class="tb-sec"><button class="cp-btn" onclick="cp(this,this.nextElementSibling.querySelector('code').innerText)">ğŸ“‹</button><pre class="tb-pre language-python"><code class="language-python">${b}</code></pre></div>`;
            } else {
                codeStr = reg[nm] || '# Rule Missing';
                let p; try{p=window.eng.prs(b)}catch(e){p={}}
                let oldSt = JSON.parse(JSON.stringify(st)), ret = window.eng.run(codeStr, st, p);
                if(typeof ret === 'string'){ card.className+=" t-E"; resHtml=`<div class="tb-sec"><pre class="tb-pre" style="color:var(--r)">âŒ ${ret}</pre></div>`;
                } else { st = ret; resHtml = `<div class="tb-sec" style="border-left-color:var(--purp);margin-bottom:8px"><span style="font-size:10px;color:var(--purp)">INPUT:</span><pre class="tb-pre">${b}</pre></div><div class="tb-sec" style="color:var(--y)">ğŸ’¬ ${st.last_action || 'OK'}</div><div class="tb-sec"><b>çŠ¶æ€å˜åŒ–:</b>${getDiffHtml(oldSt, st)}</div>`; }
            }
            card.innerHTML=`<div class="th" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='flex'?'none':'flex'"><span>${ty==='RULE'?'âš–ï¸':'ğŸš€'} <b>${nm}</b></span><span style="color:#666;font-size:11px">${new Date(c.commit.author.date).toLocaleTimeString().slice(0,5)}</span></div><div class="tb">${resHtml}</div>`;
            tl.insertBefore(card, tl.firstChild);
        }
        Prism.highlightAllUnder(tl);
        document.getElementById('st').innerText=JSON.stringify(st,null,2);
        Object.keys(reg).forEach(k=>{let t=document.createElement('span');t.className='reg-tag';t.innerText=k;t.onclick=()=>{document.getElementById('m-sel').value='RULE';swM();document.getElementById('r-name').value=k;document.getElementById('ed').value=reg[k];onEdInp();tab('edit')};sc.appendChild(t)});
        renSel(); btn.innerText="åŒæ­¥"; btn.disabled=false;
    }catch(e){alert('Sync Error: '+e);btn.innerText="Retry";btn.disabled=false}
}
async function cmt(){
    let rp=document.getElementById('repo').value, tk=document.getElementById('token').value, btn=document.getElementById('c-btn');
    let m=document.getElementById('m-sel').value, b=document.getElementById('ed').value, n=m==='ACTION'?document.getElementById('r-sel').value:document.getElementById('r-name').value;
    if(!n)return alert('Name invalid'); btn.innerText="Writing..."; btn.disabled=true;
    try{
        let sha, r=await fetch(`https://api.github.com/repos/${rp}/contents/${LOG}`,{headers:{'Authorization':`token ${tk}`}}); if(r.ok)sha=(await r.json()).sha;
        await fetch(`https://api.github.com/repos/${rp}/contents/${LOG}`,{method:'PUT',headers:{'Authorization':`token ${tk}`,'Content-Type':'application/json'},body:JSON.stringify({message:`${m} | ${n}\n\n${b}`,content:btoa(`T:${Date.now()}`),sha:sha})});
        btn.innerText="âœ… OK"; setTimeout(()=>{btn.innerText="âš¡ å†™å…¥";btn.disabled=false;sync();tab('monitor')},1000);
    }catch(e){alert('Commit Error: '+e);btn.disabled=false}
}
</script>
</body>
</html>
