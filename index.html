<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provelance Causal Console v3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; --blue: #58a6ff; --orange: #d29922; }
        body { font-family: 'Consolas', 'Monaco', monospace; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        /* å¸ƒå±€æ¡†æ¶ */
        .layout { display: grid; grid-template-columns: 300px 1fr 350px; gap: 20px; flex: 1; min-height: 0; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #21262d; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .panel-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* å·¦ä¾§ï¼šè§„åˆ™åˆ—è¡¨ */
        .rule-list-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; font-size: 13px; }
        .rule-list-item:hover { background: #1f2428; color: var(--blue); }
        .rule-tag { background: var(--border); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; }

        /* ä¸­é—´ï¼šç¼–è¾‘å™¨ */
        .editor-container { display: flex; flex-direction: column; height: 100%; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; font-family: inherit; }
        textarea { flex: 1; background: #0d1117; border: 1px solid var(--border); color: #e6edf3; padding: 15px; font-family: 'Consolas', monospace; resize: none; outline: none; line-height: 1.5; }
        .action-bar { margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2ea043; }
        button.secondary { background: var(--border); }

        /* å³ä¾§ï¼šæ—¥å¿—ä¸çŠ¶æ€ */
        .log-entry { margin-bottom: 5px; font-size: 12px; border-left: 3px solid transparent; padding-left: 8px; }
        .log-info { border-color: var(--blue); }
        .log-success { border-color: var(--accent); }
        .log-error { border-color: #f85149; }
        pre#state-output { font-size: 12px; color: #a5d6ff; margin: 0; white-space: pre-wrap; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        input.config-input { width: 200px; }
    </style>
</head>
<body onload="brython(); initApp()">

    <div class="top-bar">
        <h3>ğŸª PROVELANCE CONSOLE</h3>
        <input type="text" id="repoInput" class="config-input" placeholder="User/Repo">
        <input type="password" id="tokenInput" class="config-input" placeholder="GitHub Token (å¿…å¡«)">
        <button onclick="loadUniverse()">ğŸ”Œ è¿æ¥å®‡å®™</button>
    </div>

    <div class="layout">
        <div class="panel">
            <div class="panel-header">
                <span>ğŸ“œ è§„åˆ™æ¸…å• (Registry)</span>
                <span id="rule-count" style="font-size:12px; opacity:0.7">0</span>
            </div>
            <div class="panel-body" id="rule-list">
                <div style="text-align:center; color:#666; margin-top:20px;">ç­‰å¾…è¿æ¥...</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">ğŸ“ äº¤äº’ç¼–è¾‘å™¨ (Commitor)</div>
            <div class="panel-body" style="padding: 0;">
                <div class="editor-container" style="padding: 15px;">
                    <div class="input-row">
                        <select id="commitType" onchange="toggleTemplate()">
                            <option value="ACTION">ğŸš€ æ‰§è¡ŒåŠ¨ä½œ (ACTION)</option>
                            <option value="RULE">âš–ï¸ å®šä¹‰è§„åˆ™ (RULE)</option>
                        </select>
                        <input type="text" id="funcName" placeholder="å‡½æ•°å (e.g. init, trade)" style="flex:1">
                    </div>
                    <textarea id="codeEditor" placeholder="åœ¨æ­¤è¾“å…¥ Python ä»£ç  (RULE) æˆ– JSON å‚æ•° (ACTION)..."></textarea>
                    <div class="action-bar">
                        <button class="secondary" onclick="insertTemplate()">é‡ç½®æ¨¡æ¿</button>
                        <button onclick="commitToUniverse()" id="commitBtn">âš¡ æäº¤åˆ°å®‡å®™</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>ğŸ‘ï¸ çŠ¶æ€ (State)</span>
                <button onclick="loadUniverse()" style="padding:2px 8px; font-size:10px;">â†» åˆ·æ–°</button>
            </div>
            <div class="panel-body" style="display:flex; flex-direction:column; gap:10px;">
                <div id="log-container" style="height: 150px; overflow-y:auto; background:#000; padding:5px; border-radius:4px;"></div>
                <div style="flex:1; overflow:auto; background:#000; padding:5px; border-radius:4px;">
                    <pre id="state-output">{}</pre>
                </div>
            </div>
        </div>
    </div>

    <script type="text/python">
    from browser import window
    import ast

    def parse_params(data_str):
        if not data_str or not data_str.strip(): return {}
        try:
            return ast.literal_eval(data_str)
        except Exception as e:
            raise ValueError(f"å‚æ•°è§£æå¤±è´¥: {str(e)}")

    def execute_python_rule(user_code_str, state, params):
        lines = user_code_str.split('\n')
        indented = '\n'.join(['    ' + l for l in lines])
        wrapped = f"def logic(state, params):\n{indented}\n    return state"
        loc = {}
        try:
            exec(wrapped, {}, loc)
            new_state = loc['logic'](state, params)
            return new_state if new_state is not None else state
        except Exception as e:
            raise e

    window.parse_params = parse_params
    window.execute_python_rule = execute_python_rule
    </script>

    <script>
        const LOG_FILE = "universe.log";
        let registry = {};

        function initApp() {
            document.getElementById('repoInput').value = localStorage.getItem('provelance_repo') || '';
            document.getElementById('tokenInput').value = localStorage.getItem('provelance_token') || '';
            toggleTemplate();
        }

        function log(msg, type='info') {
            const div = document.getElementById('log-container');
            div.innerHTML += `<div class="log-entry log-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 1: æäº¤åˆ°å®‡å®™ ---
        async function commitToUniverse() {
            const repo = document.getElementById('repoInput').value;
            const token = document.getElementById('tokenInput').value;
            const type = document.getElementById('commitType').value;
            const name = document.getElementById('funcName').value.trim();
            const body = document.getElementById('codeEditor').value;
            const btn = document.getElementById('commitBtn');

            if (!name) return alert("è¯·è¾“å…¥å‡½æ•°åï¼");
            if (!token) return alert("å†™å…¥æ“ä½œå¿…é¡»æä¾› GitHub Tokenï¼");

            btn.disabled = true;
            btn.innerText = "æ­£åœ¨æäº¤...";

            try {
                // 1. è·å– universe.log çš„ SHA (å¦‚æœä¸å­˜åœ¨åˆ™ä¸º null)
                let sha = null;
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (getRes.ok) {
                    const data = await getRes.json();
                    sha = data.sha;
                } else if (getRes.status !== 404) {
                    throw new Error("æ— æ³•è¿æ¥ä»“åº“ï¼Œè¯·æ£€æŸ¥æƒé™");
                }

                // 2. æ„é€  Payload
                // å…³é”®ç‚¹ï¼šæˆ‘ä»¬åœ¨ commit message ä¸­æ”¾å…¥åè®®ï¼Œfile content åªæ˜¯å ä½ç¬¦
                const message = `${type} | ${name}\n\n${body}`;
                const content = btoa(`Updated at ${new Date().toISOString()}`); // Base64 ç¼–ç 

                // 3. æ‰§è¡Œ PUT
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${LOG_FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        content: content,
                        sha: sha // å¦‚æœæ˜¯æ–°å»ºæ–‡ä»¶ï¼Œsha ä¸º null (fetchæ—¶undefinedåœ¨JSONé‡Œä¼šè¢«å¿½ç•¥ï¼Œéœ€æ‰‹åŠ¨å¤„ç†? Github APIæ–°å»ºä¸éœ€è¦sha)
                    })
                });

                if (!putRes.ok) {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }

                log(`æäº¤æˆåŠŸ: ${type} | ${name}`, "success");
                
                // è‡ªåŠ¨åˆ·æ–°å¹¶æ¸…ç©ºè¾“å…¥
                setTimeout(loadUniverse, 2000); // ç¨å¾®å»¶è¿Ÿç­‰å¾… GitHub ç´¢å¼•

            } catch (e) {
                log(`æäº¤å¤±è´¥: ${e.message}`, "error");
                alert("æäº¤å¤±è´¥: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "âš¡ æäº¤åˆ°å®‡å®™";
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 2: è§‚æµ‹ä¸æ‹‰å– ---
        async function loadUniverse() {
            const repo = document.getElementById('repoInput').value;
            const token = document.getElementById('tokenInput').value;
            
            if(!repo) return;
            localStorage.setItem('provelance_repo', repo);
            localStorage.setItem('provelance_token', token);

            document.getElementById('log-container').innerHTML = '';
            document.getElementById('rule-list').innerHTML = '';
            log("æ­£åœ¨åŒæ­¥å› æœé“¾...");

            try {
                // æ‹‰å–æ‰€æœ‰ Commit
                let commits = [];
                let page = 1;
                const headers = token ? { 'Authorization': `token ${token}` } : {};

                while(true) {
                    const res = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=100&page=${page}`, { headers });
                    if (!res.ok) throw new Error("æ— æ³•è·å–å†å²");
                    const data = await res.json();
                    if (!data.length) break;
                    commits = commits.concat(data);
                    if (data.length < 100) break;
                    page++;
                }

                commits.reverse(); // åˆ›ä¸–é¡ºåº

                // è™šæ‹Ÿæœºæ¨æ¼”
                let state = {};
                registry = {}; // æ¸…ç©ºæ³¨å†Œè¡¨
                const ruleListEl = document.getElementById('rule-list');

                for (const item of commits) {
                    const fullMsg = item.commit.message;
                    const splitIndex = fullMsg.indexOf('\n');
                    let title = (splitIndex === -1 ? fullMsg : fullMsg.substring(0, splitIndex)).trim();
                    let body = (splitIndex === -1 ? "" : fullMsg.substring(splitIndex)).trim();

                    if (!title.includes('|')) continue;

                    const [type, funcName] = title.split('|').map(s => s.trim());

                    if (type === 'RULE') {
                        registry[funcName] = body;
                        // æ›´æ–° UI åˆ—è¡¨
                        const div = document.createElement('div');
                        div.className = 'rule-list-item';
                        div.innerHTML = `<span class="rule-tag">RULE</span> ${funcName}`;
                        div.onclick = () => loadRuleToEditor(funcName, body);
                        ruleListEl.insertBefore(div, ruleListEl.firstChild); // æœ€æ–°çš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢? ä¸ï¼Œè¿™é‡ŒæŒ‰æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬å€’åºæ’å…¥æ˜¾ç¤ºæœ€æ–°
                    } 
                    else if (type === 'ACTION') {
                        try {
                            if (!registry[funcName]) throw new Error("è§„åˆ™æœªå®šä¹‰");
                            const params = window.parse_params(body);
                            state = window.execute_python_rule(registry[funcName], state, params);
                        } catch (e) {
                            state.errors = state.errors || [];
                            state.errors.push({action: funcName, error: e.message});
                        }
                    }
                }
                
                // å€’åºæ˜¾ç¤ºè§„åˆ™åˆ—è¡¨ï¼ˆè®©æœ€æ–°çš„è§„åˆ™åœ¨ä¸Šé¢æ–¹ä¾¿æŸ¥çœ‹ï¼‰
                // ç®€å•å¤„ç†ï¼šé‡æ–°æ¸²æŸ“ä¸€ä¸‹
                ruleListEl.innerHTML = '';
                Object.keys(registry).reverse().forEach(key => {
                     const div = document.createElement('div');
                     div.className = 'rule-list-item';
                     div.innerHTML = `<span class="rule-tag">RULE</span> ${key}`;
                     div.onclick = () => loadRuleToEditor(key, registry[key]);
                     ruleListEl.appendChild(div);
                });
                document.getElementById('rule-count').innerText = Object.keys(registry).length;

                document.getElementById('state-output').textContent = JSON.stringify(state, null, 2);
                log("åŒæ­¥å®Œæˆ", "success");

            } catch (e) {
                log(e.message, "error");
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleTemplate() {
            insertTemplate();
        }

        function insertTemplate() {
            const type = document.getElementById('commitType').value;
            const editor = document.getElementById('codeEditor');
            
            if (type === 'RULE') {
                editor.value = `# å®šä¹‰é€»è¾‘\n# params å¯ç”¨ï¼Œstate å¯ä¿®æ”¹\nstate['last_update'] = 'now'\nreturn state`;
            } else {
                editor.value = `{\n    'amount': 100,\n    'note': 'test action'\n}`;
            }
        }

        function loadRuleToEditor(name, code) {
            document.getElementById('commitType').value = 'RULE';
            document.getElementById('funcName').value = name;
            document.getElementById('codeEditor').value = code;
        }
    </script>
</body>
</html>
